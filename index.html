
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BRATZ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * { 
    box-sizing: border-box; 
    /* –ó–∞–ø—Ä–µ—â–∞–µ—Ç —Å–∏–Ω—é—é –ø–æ–¥—Å–≤–µ—Ç–∫—É –¥–ª—è –í–°–ï–• —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    -webkit-tap-highlight-color: transparent !important; 
    -webkit-touch-callout: none;
         }

button, a, div[role="button"] {
    outline: none !important;
         }
        :root {
            --bg: #ffffff;
            --dark: #000000;
            --gray: #8e8e93;
            --light: #f2f2f7;
            --accent: #000000;
            --red: #ff3b30;
        }
        .disabled {
    pointer-events: none !important;
    opacity: 0.5;
}
    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–∞–∑–º–µ—Ä–æ–≤ */
.size-chip { 
    /* –í–∞—à–∏ —Ç–µ–∫—É—â–∏–µ —Å—Ç–∏–ª–∏ */
    font-size: 9px; 
    font-weight: 700; 
    padding: 4px 8px; 
    border: 1px solid #ddd; 
    color: #000;
    border-radius: 2px; 
    white-space: nowrap;
    cursor: pointer;

    /* –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –°–ò–ù–ï–ì–û –¶–í–ï–¢–ê –ù–ê –¢–ï–õ–ï–§–û–ù–ï */
    -webkit-tap-highlight-color: transparent !important;
    outline: none !important;                    
}

/* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ç–∫–æ –ø—Ä–æ–ø–∏—Å–∞–Ω–æ */
.size-chip.active { 
    background-color: #000000 !important; 
    color: #ffffff !important;
    border-color: #000000 !important;
}
/* –û—Ç–∫–ª—é—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä (—Å–µ—Ä—ã–π/–ø–µ—Ä–µ—á–µ—Ä–∫–Ω—É—Ç—ã–π) */
.size-chip.disabled, 
.size-btn.disabled {
    opacity: 0.4 !important;
    background: #f2f2f7 !important; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à—É –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é --light */
    color: #8e8e93 !important; /* –í–∞—à–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è --gray */
    border-color: #d1d1d6 !important;
    pointer-events: none; 
    text-decoration: line-through;
}
.size-chip:active {
    transform: scale(0.92); /* –ö–Ω–æ–ø–∫–∞ –±—É–¥–µ—Ç —Å–ª–µ–≥–∫–∞ —Å–∂–∏–º–∞—Ç—å—Å—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
    transition: transform 0.1s;
}

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            margin: 0; 
            background: var(--bg); 
            font-family: 'Montserrat', sans-serif; 
            color: var(--dark); 
            overflow-x: hidden; 
        }
.disabled-size {
    opacity: 0.3;
    text-decoration: line-through;
    background: #eee !important;
    cursor: not-allowed;
}
        /* Header & Search */
        .header { 
            background: #fff; padding: 15px; display: flex; align-items: center; justify-content: space-between; 
            position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #eeeeee;
        }
        .brand-name { font-size: 22px; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; }
        .search-container { padding: 10px 15px; background: #fff; border-bottom: 1px solid #eee; }
        .search-input { 
            width: 100%; padding: 12px; border: 1px solid #000; border-radius: 2px; 
            font-family: inherit; font-size: 14px; text-transform: uppercase;
        }

        .container { padding: 15px; padding-bottom: 100px; min-height: 100vh; }

        /* Categories */
        .cat-row { 
            display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; 
            padding: 5px 0; scrollbar-width: none; 
        }
        .cat-row::-webkit-scrollbar { display: none; }
        .cat-tab {
    color: #000000 !important; /* –¢–µ–∫—Å—Ç –≤—Å–µ–≥–¥–∞ —á–µ—Ä–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    cursor: pointer !important; /* –î–µ–ª–∞–µ—Ç –∫–Ω–æ–ø–∫—É –∞–∫—Ç–∏–≤–Ω–æ–π –¥–ª—è –∫–ª–∏–∫–∞ */
    transition: all 0.1s ease;
    user-select: none;
    touch-action: manipulation; /* –£–ª—É—á—à–∞–µ—Ç –æ—Ç–∫–ª–∏–∫ –Ω–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞—Ö */
}

.cat-tab:active {
    background: #000000 !important;
    transform: scale(0.95); /* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–æ—Å–µ–¥–∞–Ω–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
    opacity: 0.7;
}

        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
.fav-overlay { 
    position: absolute; top: 8px; right: 8px; z-index: 10; 
    background: rgba(255,255,255,0.7); border-radius: 50%; 
    width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
    border: none; cursor: pointer; backdrop-filter: blur(2px);
}
.card-sizes { 
    display: flex; gap: 5px; overflow-x: auto; padding: 5px 0; 
    scrollbar-width: none; margin-bottom: 8px;
}

        /* Grid */
        .products-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: #fff; border: 1px solid #f0f0f0; position: relative; overflow: hidden; }
        
        /* Slider */
        .slider-wrapper { position: relative; width: 100%; aspect-ratio: 3/4; overflow: hidden; background: #f9f9f9; }
        .slider-inner { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; height: 100%; }
        .slider-inner::-webkit-scrollbar { display: none; }
        .slider-inner img { width: 100%; height: 100%; object-fit: cover; scroll-snap-align: start; flex-shrink: 0; }
        
        .dots { position: absolute; bottom: 8px; width: 100%; display: flex; justify-content: center; gap: 4px; }
        .dot { width: 4px; height: 4px; border-radius: 50%; background: rgba(0,0,0,0.2); }
        .dot.active { background: #000; width: 10px; border-radius: 2px; }

        .card-info { padding: 12px; }
        .card-title { font-size: 11px; font-weight: 600; height: 28px; overflow: hidden; margin-bottom: 5px; text-transform: uppercase; }
        .price-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .price { font-weight: 800; font-size: 14px; }
        .old-price { font-size: 11px; color: var(--gray); text-decoration: line-through; }
        .sale-badge { background: #000; color: #fff; font-size: 9px; padding: 2px 4px; font-weight: 800; }

     /* Buttons */
.btn-row { 
    display: flex !important; 
    gap: 8px !important; 
    margin-top: 10px !important;
    /* –≠—Ç–æ –≤—ã—Ä–æ–≤–Ω—è–µ—Ç –æ–±–µ –∫–Ω–æ–ø–∫–∏ –ø–æ –Ω–∏–∂–Ω–µ–π –ª–∏–Ω–∏–∏, –µ—Å–ª–∏ –æ–Ω–∏ —Ä–∞–∑–Ω–æ–π –≤—ã—Å–æ—Ç—ã */
    align-items: flex-end !important; 
}

.btn-black { 
    background: #000 !important; 
    color: #fff !important; 
    border: none !important; 
    height: 48px !important; /* –ñ–µ—Å—Ç–∫–∞—è –≤—ã—Å–æ—Ç–∞ */
    flex: 1 !important; 
    padding: 0 !important;
    font-weight: 700 !important; 
    font-size: 11px !important; 
    text-transform: uppercase !important; 
    cursor: pointer !important; 
    border-radius: 2px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

.btn-fav { 
    background: #fff !important; 
    border: 1px solid #000 !important; 
    width: 50px !important;  
    height: 50px !important; 
    
    /* –≠—Ç–∏ —Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏ –æ–ø—É—Å—Ç—è—Ç —Å–µ—Ä–¥—Ü–µ –≤ —Ü–µ–Ω—Ç—Ä */
    display: flex !important; 
    align-items: center !important; 
    justify-content: center !important; 
    
    padding: 0 !important;   
    flex-shrink: 0 !important;
    box-sizing: border-box !important;
}

/* –†–∞–∑–º–µ—Ä –∏–∫–æ–Ω–∫–∏ –≤–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏ */
.btn-fav svg {
    margin: 0 auto !important;
    width: 24px !important; 
    height: 24px !important;
    display: block !important;
    stroke: #000 !important; /* –ß–µ—Ä–Ω—ã–π –∫–æ–Ω—Ç—É—Ä */
    color: #000 !important;
}
/* –ú–∞–ª–µ–Ω—å–∫–∏–µ –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ */
.preview-container {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin: 10px 0;
}
.preview-card {
    position: relative;
    width: 60px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä */
    height: 60px;
}
.preview-card img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* –ß—Ç–æ–±—ã —Ñ–æ—Ç–æ –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª–æ—Å—å */
    border-radius: 6px;
    border: 1px solid #ddd;
}

/* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞ –ø—Ä–µ–≤—å—é */
.remove-preview-btn {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff3b30;
    color: white;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    border: 1px solid white;
    cursor: pointer;
}


        /* Modal Product View */
        .modal { position: fixed; inset: 0; background: #fff; z-index: 2000; overflow-y: auto; padding-bottom: 50px; }
       .close-modal { 
    position: fixed; 
    top: 15px; 
    right: 15px; 
    z-index: 2100; 
    background: #fff !important; 
    color: #000 !important; 
    border: 1px solid #000 !important; 
    width: 35px; 
    height: 35px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-weight: 800;
    /* –£–±–∏—Ä–∞–µ—Ç —Å–∏–Ω–∏–π —Ü–≤–µ—Ç –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ */
    -webkit-tap-highlight-color: transparent !important; 
    outline: none !important;
}
        .size-grid { 
    display: flex; 
    gap: 10px; 
    margin: 15px 0; 
}

.size-btn { 
    flex: 1; 
    padding: 12px; 
    border: 1px solid #eee !important; 
    background: #fff !important; 
    color: #000 !important; 
    font-size: 12px; 
    font-weight: 700; 
    border-radius: 2px; 
    cursor: pointer;
    /* –£–±–∏—Ä–∞–µ—Ç —Å–∏–Ω–∏–π –±–ª–∏–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –ê–π—Ñ–æ–Ω–∞—Ö/–ê–Ω–¥—Ä–æ–∏–¥–∞—Ö */
    -webkit-tap-highlight-color: transparent !important; 
}
.size-chip.disabled {
    opacity: 0.3;
    pointer-events: none; /* –ß—Ç–æ–±—ã –Ω–µ–ª—å–∑—è –±—ã–ª–æ –∫–ª–∏–∫–Ω—É—Ç—å */
    text-decoration: line-through;
}

/* –°–æ—Å—Ç–æ—è–Ω–∏–µ, –∫–æ–≥–¥–∞ —Ä–∞–∑–º–µ—Ä –í–´–ë–†–ê–ù */
.size-btn.active, .deliv-btn.active { 
    border-color: #000 !important; 
    background: #000 !important; 
    color: #fff !important; 
}

/* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è (—á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ "–ø—Ä–æ–∂–∏–º–∞–ª–∞—Å—å") */
.size-btn:active {
    transform: scale(0.95);
    transition: transform 0.1s;
}
    

        /* Bottom Nav */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; background: #fff; 
            display: flex; justify-content: space-around; padding: 10px 0 25px; 
            border-top: 1px solid #eee; z-index: 1000; 
        }
        .nav-item { 
            border: none; background: none; color: #a1a1a1; display: flex; 
            flex-direction: column; align-items: center; font-size: 9px; font-weight: 700; 
            gap: 4px; text-transform: uppercase; position: relative;
        }
        .nav-item.active { color: #000; }
        .nav-item svg { width: 20px; height: 20px; }
        .badge { 
            position: absolute; top: -5px; right: -8px; background: var(--red); 
            color: #fff; font-size: 9px; padding: 2px 5px; border-radius: 10px; font-weight: 800;
        }

        /* Cart & Order Form */
        .cart-item { display: flex; gap: 15px; padding: 15px 0; border-bottom: 1px solid #eee; }
        .cart-img { width: 80px; aspect-ratio: 3/4; object-fit: cover; }
        .qty-controls { display: flex; align-items: center; gap: 15px; margin-top: 10px; }
        .qty-btn { width: 25px; height: 25px; border: 1px solid #000; background: none; font-weight: 800; }

        #map { width: 100%; height: 300px; background: #f0f0f0; margin: 15px 0; border: 1px solid #000; }
        .delivery-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 15px 0; }

        /* Admin Styles */
        .admin-section { background: #f9f9f9; padding: 15px; border-radius: 2px; margin-top: 20px; border: 1px solid #eee; }
        .field { margin-bottom: 15px; }
        .field label { display: block; font-size: 10px; font-weight: 800; margin-bottom: 5px; text-transform: uppercase; }
        .input-admin { width: 100%; padding: 12px; border: 1px solid #ddd; font-family: inherit; font-size: 13px; border-radius: 2px; }
        
        .order-card { background: #fff; border: 1px solid #eee; padding: 15px; margin-bottom: 10px; color: #000; }
        .status-badge { display: inline-block; padding: 4px 8px; font-size: 9px; font-weight: 800; text-transform: uppercase; margin-top: 5px; }
        .status-ready { background: #e8f5e9; color: #2e7d32; }
        .status-process { background: #fff3e0; color: #ef6c00; }

        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    
    <header class="header">
        <button @click="burgerOpen = !burgerOpen; vib()" style="border:none; background:none;">
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="#000000" stroke-width="2" fill="none"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <div class="brand-name">BRATZ</div>
        <div class="header-side" style="justify-content: flex-end;">
        <button v-if="tab === 'catalog'" @click="searchMode = !searchMode; vib()" style="border:none; background:none; padding:0;">
            <svg viewBox="0 0 24 24" width="22" height="22" stroke="#000000" stroke-width="2.5" fill="none"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </button>
    </div>
    </header>

    <div v-if="searchMode && tab === 'catalog'" class="search-container">
    <input v-model="searchQuery" class="search-input" placeholder="–ü–û–ò–°–ö –¢–û–í–ê–†–ê..." @input="vib()">
</div>

    <div v-if="burgerOpen" class="modal" style="padding: 40px; z-index: 3000; overflow-y: auto;">
    <button class="close-modal" @click="burgerOpen = false">‚úï</button>
    <div class="brand-name" style="margin-bottom: 40px;">BRATZ</div>
    
    <div style="display: flex; flex-direction: column; gap: 10px;">
        
        <div class="menu-accordion">
            <div class="menu-item" @click="activeInfo = activeInfo === 'about' ? null : 'about'; haptic()" 
                 style="display: flex; justify-content: space-between; font-weight: 700; padding: 15px 0; border-bottom: 1px solid #eee;">
                <span>–û –ù–ê–°</span>
                <span>{{ activeInfo === 'about' ? '‚àí' : '+' }}</span>
            </div>
            <div v-if="activeInfo === 'about'" style="padding: 15px 0; font-size: 13px; line-height: 1.6; color: #666; animation: fadeIn 0.3s ease;">
                –¢–æ–≤–∞—Ä –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –Ω–∞ —Ñ–∞–±—Ä–∏–∫–∞—Ö –¢—É—Ä—Ü–∏–∏ –∏ –ö–∏—Ç–∞—è. –ö–∞—á–µ—Å—Ç–≤–æ LUXE, –Ω–µ –ø—É—Ç–∞–π—Ç–µ —Å –¥–µ—à–µ–≤—ã–º –ø–µ—Ä–µ—à–∏–≤–æ–º.–í—Å–µ —Ñ–æ—Ç–æ –≤ –≥—Ä—É–ø–ø–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ: –ª–∏–±–æ –Ω–∞ –Ω–∞—à–µ–π –¥–µ–≤–æ—á–∫–µ-–º–æ–¥–µ–ª–∏, –ª–∏–±–æ —Å —Ñ–∞–±—Ä–∏–∫. –û–¥–µ–∂–¥–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞—è–≤–ª–µ–Ω–Ω—ã–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º –∏ –±–æ–ª–µ–µ —á–µ–º –æ–ø—Ä–∞–≤–¥—ã–≤–∞–µ—Ç –∫–∞–∂–¥—É—é –∫–æ–ø–µ–π–∫—É. –¶–µ–Ω—ã –≤ –≥—Ä—É–ø–ø–µ —É–∫–∞–∑–∞–Ω—ã –æ–ø—Ç–æ–≤—ã–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π.–ü—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è –±—Ä–æ–Ω–∏ –ø–æ 100% –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–µ
            </div>
        </div>

        <div class="menu-accordion">
            <div class="menu-item" @click="activeInfo = activeInfo === 'delivery' ? null : 'delivery'; haptic()" 
                 style="display: flex; justify-content: space-between; font-weight: 700; padding: 15px 0; border-bottom: 1px solid #eee;">
                <span>–î–û–°–¢–ê–í–ö–ê</span>
                <span>{{ activeInfo === 'delivery' ? '‚àí' : '+' }}</span>
            </div>
            <div v-if="activeInfo === 'delivery'" style="padding: 15px 0; font-size: 13px; line-height: 1.6; color: #666; animation: fadeIn 0.3s ease;">
                –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –∑–∞–∫–∞–∑—á–∏–∫–æ–º. –°—Ç–æ–∏–º–æ—Å—Ç—å –∏ —Å—Ä–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ—Å—ã–ª–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç–µ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ, —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤—É—è—Å—å —Ç–∞—Ä–∏—Ñ–∞–º–∏ –ø–æ—á—Ç—ã –∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π, –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ –∏—Ö –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∞–π—Ç–∞—Ö. –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∞–≤—Ç–æ–±—É—Å–æ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ –µ–≥–æ –Ω–æ–º–µ—Ä, –≥–æ—Ä–æ–¥, —Å—Ç–æ—è–Ω–∫—É –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤–æ–¥–∏—Ç–µ–ª—è. 
            </div>
        </div>

        <div class="menu-accordion">
            <div class="menu-item" @click="activeInfo = activeInfo === 'return' ? null : 'return'; haptic()" 
                 style="display: flex; justify-content: space-between; font-weight: 700; padding: 15px 0; border-bottom: 1px solid #eee;">
                <span>–í–û–ó–í–†–ê–¢</span>
                <span>{{ activeInfo === 'return' ? '‚àí' : '+' }}</span>
            </div>
            <div v-if="activeInfo === 'return'" style="padding: 15px 0; font-size: 13px; line-height: 1.6; color: #666; animation: fadeIn 0.3s ease;">
                –ü—Ä–∏ —Å–∞–º–æ–≤—ã–≤–æ–∑–µ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ –∏ –æ–±–º–µ–Ω–æ–≤ –ù–ï–¢! –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ç–æ–≤–∞—Ä –Ω–∞ –±—Ä–∞–∫ –Ω–∞ –º–µ—Å—Ç–µ –∏–ª–∏ –ø—Ä–æ—Å–∏—Ç–µ –ø–æ—Å—Ä–µ–¥–Ω–∏–∫–æ–≤. –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ, –ø–æ–ª—É—á–∞—è —Ç–æ–≤–∞—Ä —Å–Ω–∏–º–∞–π—Ç–µ —Ä–∞—Å–ø–∞–∫–æ–≤–∫—É –Ω–∞ –≤–∏–¥–µ–æ. –í —Å–ª—É—á–∞–µ –±—Ä–∞–∫–∞ —Ä–µ—à–∏–º –ø—Ä–æ–±–ª–µ–º—É! –¢–æ–ª—å–∫–æ –ø–∏—à–∏—Ç–µ —Å—Ä–∞–∑—É, 1-2 –¥–Ω—è —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è.
            </div>
        </div>

        <div class="menu-accordion">
            <div class="menu-item" @click="activeInfo = activeInfo === 'address' ? null : 'address'; haptic()" 
                 style="display: flex; justify-content: space-between; font-weight: 700; padding: 15px 0; border-bottom: 1px solid #eee;">
                <span>–ù–ê–® –ê–î–†–ï–°</span>
                <span>{{ activeInfo === 'address' ? '‚àí' : '+' }}</span>
            </div>
            <div v-if="activeInfo === 'address'" style="padding: 15px 0; font-size: 13px; line-height: 1.6; color: #666; animation: fadeIn 0.3s ease;">
                –≥. –ú–æ—Å–∫–≤–∞, 14 –∫–º. –ú–ö–ê–î, –¢–¶ –°–∞–¥–æ–≤–æ–¥, –º–µ—Å—Ç–æ 2–í-73 –∫–æ—Ä–ø—É—Å –ë. –ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ —Å 8:00 –¥–æ 18:00
            </div>
        </div>

    </div>
</div>

    <main class="container">
    <div v-if="tab === 'catalog'">
        <div class="cat-row">
            <button @click="setCategory('')" :class="['cat-tab', currentCat === '' ? 'active' : '']">–í–°–ï –¢–û–í–ê–†–´</button>
            <button v-for="cat in categories" :key="cat.id" @click="setCategory(cat.name)" :class="['cat-tab', currentCat === cat.name ? 'active' : '']">
                {{cat.name}}
            </button>
        </div>

       <div class="products-grid">
    <div v-for="p in filteredProducts" :key="p.id" class="card">
        <div class="slider-wrapper">
            <button class="fav-overlay" @click.stop="toggleFav(p)">
                <svg :fill="isFav(p) ? '#ff3b30' : 'none'" viewBox="0 0 24 24" width="20" height="20" :stroke="isFav(p) ? '#ff3b30' : '#000'" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
            </button>

            <div class="slider-inner" @scroll="e => handleScroll(e, p)" @click="openProduct(p)">
                <template v-if="p.variants && p.variants.length > 0">
                    <img v-for="img in p.variants[0].images" :key="img" :src="img" loading="lazy">
                </template>
                <img v-else v-for="img in p.images" :key="img" :src="img" loading="lazy">
            </div>

            <div class="dots" v-if="p.variants?.[0]?.images?.length > 1">
                <span v-for="(img, i) in p.variants[0].images" :key="i" :class="['dot', {active: i === (p.aIdx || 0)}]"></span>
            </div>

            <div v-if="p.oldPrice" class="sale-badge" style="position:absolute; top:10px; left:10px;">SALE</div>
            <div v-if="p.isNew" class="new-badge" :style="{ position: 'absolute', top: p.oldPrice ? '35px' : '10px', left: '10px', background: '#000', color: '#fff', fontSize: '10px', fontWeight: '800', padding: '4px 8px', borderRadius: '4px', zIndex: 5 }">NEW</div>
        </div>

        <div class="card-info">
            <div class="card-title" @click="openProduct(p)">{{p.title}}</div>
            <div class="price-row" @click="openProduct(p)">
                <span class="price">{{p.price}} ‚ÇΩ</span>
                <span v-if="p.oldPrice" class="old-price">{{p.oldPrice}} ‚ÇΩ</span>
            </div>
            
           <div class="card-sizes" v-if="p.variants && p.variants[0]">
    <div v-for="(qty, sz) in (p.variants[0].stocks || p.variants[0].stocks)" 
         :key="sz"
         @click.stop="qty > 0 ? (p.tempSize = sz, vib()) : null"
         :class="['size-chip', {
            /* –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ª–∏–±–æ —Ç–æ, —á—Ç–æ –≤—ã–±—Ä–∞–ª–∏, –ª–∏–±–æ –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –µ—Å–ª–∏ –µ—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ */
            active: p.tempSize === sz,
            disabled: qty <= 0
         }]">
        {{ sz }}
    </div>
</div>
            <button class="btn-black" style="width: 100%;" @click.stop="quickAddToCart(p)">
                –í –ö–û–†–ó–ò–ù–£
            </button>
        </div>
    </div>
</div>
        <div v-if="filteredProducts.length === 0" style="text-align:center; padding: 50px; font-weight: 700;">–¢–û–í–ê–†–û–í –ù–ï –ù–ê–ô–î–ï–ù–û</div>
    </div>

    <div v-if="tab === 'favs'">
    <h2 class="brand-name" style="font-size: 16px; margin-bottom: 20px;">–ò–ó–ë–†–ê–ù–ù–û–ï</h2>
    
    <div v-if="favList.length === 0" style="text-align:center; padding: 50px; color: #999;">
        –ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ
    </div>
    
    <div class="products-grid">
        <div v-for="p in favList" :key="p.id" class="card">
            
            <div class="slider-wrapper">
                <button class="fav-overlay" @click.stop="toggleFav(p)">
                    <svg :fill="isFav(p) ? '#ff3b30' : 'none'" viewBox="0 0 24 24" width="20" height="20" 
                         :stroke="isFav(p) ? '#ff3b30' : '#000'" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                </button>

                <div class="slider-inner" @scroll="e => handleScroll(e, p)" @click="openProduct(p)">
                    <template v-if="p.variants && p.variants[0]">
                        <img v-for="img in p.variants[0].images" :key="img" :src="img" loading="lazy">
                    </template>
                    <img v-else-if="p.images && p.images[0]" :src="p.images[0]" loading="lazy">
                </div>

                <div class="dots" v-if="p.variants && p.variants[0]?.images?.length > 1">
                    <span v-for="(img, i) in p.variants[0].images" :key="i" 
                          :class="['dot', {active: i === (p.aIdx || 0)}]"></span>
                </div>
            </div>

            <div class="card-info">
                <div class="card-title" @click="openProduct(p)">{{p.title}}</div>
                <div class="price-row" @click="openProduct(p)">
                    <span class="price">{{p.price}} ‚ÇΩ</span>
                </div>

                <div class="card-sizes" v-if="p.variants && p.variants[0]">
    <div v-for="(qty, sz) in p.variants[0].stocks" 
         :key="sz"
         /* –ü–†–û–í–ï–†–ö–ê: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –ù–ï –≤ —Å–ø–∏—Å–∫–µ —Å–∫—Ä—ã—Ç—ã—Ö */
         v-if="!(p.hiddenSizes || []).includes(String(sz))"
         @click.stop="qty > 0 ? (p.tempSize = sz, vib('light')) : null"
         :class="['size-chip', {
            active: p.tempSize === sz,
            disabled: qty <= 0
         }]">
        {{ sz }}
    </div>
</div>

                <button class="btn-black" style="width: 100%; margin-top: 5px; text-transform: uppercase; font-size: 11px;" 
                        @click.stop="openProduct(p)">
                    –ö–£–ü–ò–¢–¨
                </button>
            </div> 
        </div> 
    </div>
</div>
                
                <div v-if="tab === 'cart'">
        <h2 class="brand-name" style="font-size: 16px; margin-bottom: 20px;">–ö–û–†–ó–ò–ù–ê</h2>
<div v-if="cart.length === 0" style="text-align:center; padding: 50px;">–í–ê–®–ê –ö–û–†–ó–ò–ù–ê –ü–£–°–¢–ê</div>
<div v-else>
   <div v-for="item in cart" :key="item.cartId" class="cart-item">
    <img :src="item.image || (item.variants && item.variants[0]?.images[0])" 
         class="cart-img" 
         @click="openProduct(item)" 
         style="cursor:pointer; width: 70px; height: 90px; object-fit: cover; border-radius: 8px;">

    <div style="flex:1; margin-left: 12px;">
        <div @click="openProduct(item)" style="cursor:pointer;">
            <div style="font-weight:700; font-size:12px; text-transform:uppercase; letter-spacing: 0.5px;">
                {{item.title}}
            </div>
            
            <div style="font-size:10px; color:gray; margin: 4px 0; font-weight: 600;">
                –†–ê–ó–ú–ï–†: {{item.selSize}} | –¶–í–ï–¢: {{item.selColor}}
            </div>
            
            <div style="font-weight:800; font-size: 14px;">{{item.price}} ‚ÇΩ</div>
        </div>

        <div class="qty-controls" style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
            <button class="qty-btn" @click="changeQty(item, -1)" 
                    style="width: 28px; height: 28px; border: 1px solid #eee; background: #fff; border-radius: 4px;">-</button>
            
            <span style="font-weight:700; font-size: 13px;">{{item.qty}}</span>
            
            <button class="qty-btn" @click="changeQty(item, 1)"
                    style="width: 28px; height: 28px; border: 1px solid #eee; background: #fff; border-radius: 4px;">+</button>
        </div>
    </div>
    
    <button @click="removeFromCart(item.cartId)" 
            style="background: none; border: none; color: #ccc; padding: 5px; font-size: 18px;">‚úï</button>
</div>

    <div style="margin-top: 30px;">
        <div class="field">
            <label>–í–ê–®–ï –ò–ú–Ø</label>
            <input v-model="form.name" class="input-admin" placeholder="–ò–ú–Ø">
        </div>
        <div class="field">
            <label>–¢–ï–õ–ï–§–û–ù (10-11 –¶–ò–§–†)</label>
            <input v-model="form.phone" class="input-admin" type="tel" placeholder="89000000000">
        </div>

        <label style="font-size:10px; font-weight:800;">–°–ü–û–°–û–ë –î–û–°–¢–ê–í–ö–ò</label>
        <div class="delivery-grid">
            <button v-for="d in ['–°–î–≠–ö', '–ü–û–ß–¢–ê', '5POST']" :key="d" @click="setDelivery(d)" :class="['cat-tab', {active: deliv === d}]">{{d}}</button>
        </div>

        <div id="map" v-show="deliv"></div>
        <div v-if="address" style="font-size:12px; font-weight:700; margin-bottom: 20px;">üìç {{address}}</div>
     <div class="field" style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 8px;">
    <label style="font-weight: 800; font-size: 11px; color: #666;">–°–ü–û–°–û–ë –î–û–°–¢–ê–í–ö–ò</label>
    <div style="font-size: 13px; font-weight: 700; color: #000; margin-top: 4px;">
        üì¶ –î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –ø—É–Ω–∫—Ç–∞ ‚Äî 200 ‚ÇΩ
    </div>
    <div style="font-size: 9px; color: #999;">(–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ –≤—Å–µ–º –∑–∞–∫–∞–∑–∞–º)</div>
</div>

<div style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 2px; border: 1px solid #eee;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 13px; font-weight: 800;">–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï:</span>
            <span style="font-size: 18px; font-weight: 800;">{{ total().toLocaleString() }} ‚ÇΩ</span>
        </div>
    </div>

        <div style="font-size: 9px; color: var(--gray); line-height: 1.2; margin-bottom: 15px; text-align: center;">
            –ù–∞–∂–∏–º–∞—è –Ω–∞ –∫–Ω–æ–ø–∫—É, –≤—ã –¥–∞–µ—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å 152-–§3 –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞.
        </div>

        <button class="btn-black" style="width:100%; height:60px; font-size: 14px;" @click="checkout">
            –û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó ‚Äî {{ total().toLocaleString() }} ‚ÇΩ
        </button>
    </div>
</div>
    </div>

   <div v-if="tab === 'profile'">
    <div style="text-align:center; margin-bottom: 30px;">
        <img :src="user.photo_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" style="width:80px; height:80px; border-radius:50%; border: 1px solid #000; padding: 3px;">
        <div style="font-weight:800; margin-top:10px; text-transform:uppercase;">{{user.first_name || '–ö–ª–∏–µ–Ω—Ç'}}</div>
        <button @click="openSupport" class="cat-tab" style="margin-top:15px; width:100%;">–ù–ê–ü–ò–°–ê–¢–¨ –í –ü–û–î–î–ï–†–ñ–ö–£</button>
    </div>

    <div v-if="!isAdmin">
        <h3 class="brand-name" style="font-size: 14px; margin-bottom: 15px;">–ú–û–ò –ó–ê–ö–ê–ó–´</h3>
        
        <div v-if="myOrders.length === 0" style="padding:20px; text-align:center; font-size:12px; color: var(--gray);">
            –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤
        </div>

        <div v-for="o in myOrders" :key="o.id" class="order-card" style="background: var(--light); padding: 15px; border-radius: 12px; margin-bottom: 10px;">
            <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight:800; font-size:12px; letter-spacing: 0.5px;">–ó–ê–ö–ê–ó ‚Ññ{{o.order_id}}</span>
                <span style="font-weight:800; font-size:14px;">{{ o.order_total || o.total }} ‚ÇΩ</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div :class="['status-badge', o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' ? 'status-ready' : 'status-process']" style="font-size: 10px; margin-top: 0;">
                    {{o.status || '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ'}}
                </div>
                <div style="font-size:10px; color:gray; font-weight: 600;">{{o.date}}</div>
            </div>
        </div>
    </div> 
    
    <div v-if="isAdmin" class="admin-section">
        <h2 class="brand-name" style="font-size: 14px; margin-bottom: 20px;">–ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨</h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px;">
             <div style="background: var(--light); color: var(--dark); padding: 16px; border-radius: 15px;">
                <div style="font-size: 9px; font-weight: 800; opacity: 0.6; letter-spacing: 1px; margin-bottom: 5px;">–°–ï–ì–û–î–ù–Ø</div>
                <div style="font-size: 18px; font-weight: 800;">{{ stats.todayRev.toLocaleString() }} ‚ÇΩ</div>
                <div style="font-size: 10px; opacity: 0.8;">{{ stats.todayCount }} –∑–∞–∫.</div>
             </div>
             <div style="background: var(--light); color: var(--dark); padding: 16px; border-radius: 15px;">
                <div style="font-size: 9px; font-weight: 800; color: var(--gray); letter-spacing: 1px; margin-bottom: 5px;">–ú–ï–°–Ø–¶</div>
                <div style="font-size: 18px; font-weight: 800;">{{ stats.monthRev.toLocaleString() }} ‚ÇΩ</div>
                <div style="font-size: 10px; color: var(--gray);">{{ stats.monthCount }} –∑–∞–∫.</div>
             </div>
             <div style="grid-column: span 2; background: #fff; padding: 16px; border-radius: 15px; border: 1px solid var(--light); display: flex; justify-content: space-between; align-items: center;">
                 <div>
                    <div style="font-size: 9px; font-weight: 800; color: var(--gray); letter-spacing: 1px;">–û–ë–©–ê–Ø –í–´–†–£–ß–ö–ê</div>
                    <div style="font-size: 20px; font-weight: 800;">{{ stats.allRev.toLocaleString() }} ‚ÇΩ</div>
                 </div>
                 <div style="text-align: right;">
                    <div style="font-size: 9px; font-weight: 800; color: var(--gray); letter-spacing: 1px;">–í–°–ï–ì–û –ó–ê–ö–ê–ó–û–í</div>
                    <div style="font-size: 20px; font-weight: 800;">{{ stats.allCount }}</div>
                 </div>
             </div>
        </div>

        <div style="background: #fff; padding: 15px; border-radius: 20px; border: 1px solid #eee; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.03);">
             <div style="font-size: 10px; font-weight: 800; color: var(--gray); letter-spacing: 1px; margin-bottom: 15px;">–î–ò–ù–ê–ú–ò–ö–ê –ó–ê–ö–ê–ó–û–í (7 –î–ù–ï–ô)</div>
            <canvas id="orderChart" style="max-height: 200px;"></canvas>
        </div>
        
       <div class="field">
    <label>–î–û–ë–ê–í–ò–¢–¨ –ö–ê–¢–ï–ì–û–†–ò–Æ</label>
    <div style="display:flex; gap:10px;">
        <input v-model="newCat" class="input-admin" placeholder="–ù–ê–ó–í–ê–ù–ò–ï">
        <button class="btn-black" @click="manageCategory('add')" style="padding: 10px;">+</button>
    </div>
    <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;">
        <span v-for="c in categories" :key="c.id" class="sale-badge" @click="manageCategory('del', c.id)">
            {{c.name}} ‚úï
        </span>
    </div>
</div>

<hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

<div class="field">
    <label>–ö–ê–¢–ï–ì–û–†–ò–Ø</label>
    <select v-model="newP.category" class="input-admin">
        <option v-for="c in categories" :key="c.id" :value="c.name">{{c.name}}</option>
    </select>
</div>

<div class="field">
    <label>–¢–û–í–ê–†: –ù–ê–ó–í–ê–ù–ò–ï</label>
    <input v-model="newP.title" class="input-admin">
</div>

<div class="field">
    <label>–û–ü–ò–°–ê–ù–ò–ï</label>
    <textarea v-model="newP.desc" class="input-admin" style="height:80px;"></textarea>
</div>

<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
    <div class="field">
        <label>–¶–ï–ù–ê (‚ÇΩ)</label>
        <input v-model="newP.price" type="number" class="input-admin">
    </div>
    <div class="field">
        <label>–°–¢–ê–†–ê–Ø –¶–ï–ù–ê (SALE)</label>
        <input v-model="newP.oldPrice" type="number" class="input-admin">
    </div>
</div>

<div class="field" style="margin-top: 10px;">
    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
        <input type="checkbox" v-model="newP.isNew" style="width: 18px; height: 18px; accent-color: #000;"> 
        –ü–û–°–¢–ê–í–ò–¢–¨ –ü–õ–ê–®–ö–£ "NEW"
    </label>
</div>

<hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

<div style="margin-top: 20px;">
    <label style="font-weight: 800; font-size: 12px;">–í–ê–†–ò–ê–ù–¢–´ –¶–í–ï–¢–û–í, –§–û–¢–û –ò –†–ê–ó–ú–ï–†–´</label>
    
    <div v-for="(v, vIdx) in newP.variants" :key="vIdx" 
         style="border: 1px solid #eee; padding: 15px; margin-top: 10px; position: relative; background: #fafafa; border-radius: 8px;">
        
        <button @click="newP.variants.splice(vIdx, 1)" 
                style="position: absolute; right: 5px; top: 5px; background: none; border: none; color: red; font-weight: bold; cursor: pointer;">‚úï</button>

        <div class="field">
            <label>–¶–í–ï–¢</label>
            <input v-model="v.color" class="input-admin" placeholder="–ù–∞–ø—Ä: –ß–µ—Ä–Ω—ã–π">
        </div>

        <div class="field">
            <label>–û–°–¢–ê–¢–ö–ò –ü–û –†–ê–ó–ú–ï–†–ê–ú</label>
            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <div v-for="sz in ['42', '44', '46', '48', '50']" :key="sz" style="text-align: center;">
                    <div style="font-size: 10px;">{{sz}}</div>
                    <input type="number" 
                           v-model.number="v.stocks[sz]" 
                           class="input-admin" 
                           style="width: 50px; padding: 5px; text-align: center;">
                </div>
            </div>
        </div>

        <div class="field">
            <label>–§–û–¢–û –¶–í–ï–¢–ê (–ó–ê–ì–†–£–ó–ö–ê)</label>
            <input type="file" multiple @change="(e) => uploadVariantImages(e, vIdx)" class="input-admin" style="padding: 8px;">
            <div style="display: flex; gap: 5px; margin-top: 5px; overflow-x: auto; padding-bottom: 5px;">
                <img v-for="img in v.images" :key="img" :src="img" style="width: 40px; height: 50px; object-fit: cover; border: 1px solid #ddd; border-radius: 4px;">
                <div v-if="v.isUploading" class="loader-mini" style="font-size: 10px;">–ó–ê–ì–†–£–ó–ö–ê...</div>
            </div>
        </div>
    </div>

    <button type="button" class="btn-black" @click="addVariant" style="margin-top: 10px; background: #333 !important; width: 100%;">+ –î–û–ë–ê–í–ò–¢–¨ –¶–í–ï–¢</button>
</div>

<div style="margin-top: 20px;">
    <button class="btn-black" style="width:100%;" @click="saveProduct" :disabled="loading">
        {{ loading ? '–ó–ê–ì–†–£–ó–ö–ê...' : (editId ? '–°–û–•–†–ê–ù–ò–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–Ø' : '–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨ –¢–û–í–ê–†') }}
    </button>
    <button v-if="editId" class="cat-tab" style="width:100%; margin-top:10px;" @click="cancelEdit">–û–¢–ú–ï–ù–ê</button>
</div>

       <div style="margin-top: 20px; border: 1px solid #eee; border-radius: 12px; overflow: hidden; background: #f9f9f9;">
    <div @click="showProductList = !showProductList" style="padding: 15px; background: #000; color: #fff; display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
        <span style="font-weight: 800; font-size: 11px; letter-spacing: 1px;">üì¶ –°–ü–ò–°–û–ö –¢–û–í–ê–†–û–í ({{ products.length }})</span>
        <span style="font-size: 18px;">{{ showProductList ? '‚àí' : '+' }}</span>
    </div>
    
   <div v-if="showProductList" style="padding: 5px; max-height: 500px; overflow-y: auto; background: #fff;">
    <template v-for="p in products" :key="p.id">
        <div v-for="(v, vIdx) in p.variants" :key="p.id + vIdx" 
             style="padding: 15px; border-bottom: 2px solid #f2f2f7; background: #fff;" 
             :style="{ opacity: p.hidden ? '0.5' : '1' }">
            
            <div style="display: flex; gap: 15px; align-items: start;">
                <img :src="v.images?.[0] || ''" style="width: 55px; height: 75px; object-fit: cover; border-radius: 8px; border: 1px solid #eee;">
                
                <div style="flex: 1;">
                    <div style="font-weight: 800; font-size: 13px; text-transform: uppercase;">{{ p.title }}</div>
                    <div style="font-size: 11px; color: #000; font-weight: 700; margin-bottom: 8px;">–¶–í–ï–¢: {{ v.color }}</div>
                    
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <div v-for="(qty, sz) in (v.stocks || v.stock || {})" :key="sz" 
                             style="display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 6px 8px; border-radius: 6px;">
                            
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                <span style="font-size: 12px; font-weight: 600; min-width: 25px;" 
                                      :style="{ 
                                          color: (v.hiddenSizes || []).includes(String(sz)) ? '#ccc' : '#000', 
                                          textDecoration: (v.hiddenSizes || []).includes(String(sz)) ? 'line-through' : 'none' 
                                      }">
                                    {{ sz }}
                                </span>
                                
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <span style="font-size: 9px; color: #999;">–®–¢:</span>
                                    <input type="number" 
                                           v-model.number="v.stocks[sz]" 
                                           @change="updateStock(p)"
                                           style="width: 45px; border: 1px solid #ddd; border-radius: 4px; padding: 2px; font-size: 11px; font-weight: bold; text-align: center;">
                                </div>
                            </div>

                            <button @click="toggleVariantSizeVisibility(p, v, sz)" 
                                    :style="{ 
                                        border: 'none', 
                                        background: 'none', 
                                        fontSize: '10px', 
                                        fontWeight: '800', 
                                        color: (v.hiddenSizes || []).includes(String(sz)) ? '#34c759' : '#ff3b30', 
                                        textTransform: 'uppercase', 
                                        cursor: 'pointer' 
                                    }">
                                {{ (v.hiddenSizes || []).includes(String(sz)) ? '–û–¢–ö–†–´–¢–¨' : '–°–ö–†–´–¢–¨' }}
                            </button>
                        </div>
                    </div>
                </div>

                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button @click="editProduct(p)" style="border:none; background:none; font-size: 20px; cursor: pointer;">‚úèÔ∏è</button>
                    <button @click="deleteProductWithConfirm(p.id)" style="border:none; background:none; font-size: 20px; cursor: pointer;">üóë</button>
                </div>
            </div>
        </div>
    </template>
</div>


        <hr style="margin: 20px 0; border: none; border-top: 2px solid #000;">   
        <h3 class="brand-name" style="font-size:12px; margin-top:2px;">–ó–ê–ö–ê–ó–´ ({{allOrders.length}}) | –í–´–†–£–ß–ö–ê: {{revenue}} ‚ÇΩ</h3>
        
        <div v-for="o in allOrders" :key="o.id" class="order-card" style="background: #ffffff; border-radius: 20px; padding: 16px; margin-bottom: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.03);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div><div style="font-weight: 800; font-size: 16px; display: block;">#{{ o.order_id }}</div></div>
                <div @click="deleteOrder(o.id); vib()" style="color: #ff3b30; font-size: 10px; font-weight: 800; cursor: pointer; border: 1.5px solid #ff3b30; padding: 4px 8px; border-radius: 8px; text-transform: uppercase;">–£–î–ê–õ–ò–¢–¨ üóë</div>
            </div>
            <div style="font-size: 13px; color: #000; margin-bottom: 12px; line-height: 1.4;">
                <div style="margin-bottom: 2px;">üë§ <b>{{ o.customer_name }}</b></div>
                <div style="margin-bottom: 2px;">üìû <span style="color: #007aff;">{{ o.customer_phone }}</span></div>
                <div style="color: #8e8e93; font-size: 12px;">üìç {{ o.address }} ({{ o.delivery || o.delivery_type }})</div>
            </div>
            <div style="background: #f2f2f7; padding: 10px; border-radius: 12px; margin-bottom: 15px;">
                <div v-if="o.items && o.items.length > 0">
                    <div v-for="item in o.items" :key="item.id" style="font-size: 12px; margin-bottom: 6px; border-bottom: 1px solid #e5e5ea; padding-bottom: 4px; color: #000;">
                        <div style="font-weight: 700;">{{ item.title }} ‚Äî {{ item.count || 1 }} —à—Ç.</div>
                        <div style="font-size: 11px; color: #8e8e93;">üé® –¶–≤–µ—Ç: {{ item.color || '-' }} | üìè –†–∞–∑–º: {{ item.size || item.selSize || '-' }}</div>
                    </div>
                </div>
                <div v-else style="font-size: 12px; white-space: pre-wrap;">{{ o.items_text }}</div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <span style="font-size: 11px; font-weight: 700; color: #8e8e93;">–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï</span>
                <span style="font-size: 18px; font-weight: 800;">{{ o.order_total }} ‚ÇΩ</span>
            </div>
            <div style="display: flex; gap: 8px;">
                <button @click="updateStatus(o, '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω')" :disabled="o.status === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω' || o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' || o.isUpdating" :style="{ flex: '1', height: '46px', borderRadius: '12px', border: 'none', fontSize: '10px', fontWeight: '800', background: (o.status === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω' || o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω') ? '#34c759' : '#ff3b30', color: '#fff' }">{{ (o.status === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω' || o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω') ? '–û–¢–ü–†–ê–í–õ–ï–ù–û ‚úÖ' : '–û–¢–ü–†–ê–í–ò–¢–¨' }}</button>
                <button @click="updateStatus(o, '–î–æ—Å—Ç–∞–≤–ª–µ–Ω')" :disabled="o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' || o.isUpdating" :style="{ flex: '1', height: '46px', borderRadius: '12px', border: 'none', fontSize: '10px', fontWeight: '800', background: o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' ? '#34c759' : '#ff3b30', color: '#fff' }">{{ o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' ? '–î–û–°–¢–ê–í–õ–ï–ù–û ‚úÖ' : '–î–û–°–¢–ê–í–ò–¢–¨' }}</button>
                <button @click="printOrder(o)" style="width: 46px; height: 46px; border-radius: 12px; border: 1px solid #eee; background: #fff; font-size: 20px; display: flex; align-items: center; justify-content: center;">üìÑ</button>
            </div>
        </div>      
    </div> </div> </main>

  <div v-if="selP" class="modal" style="z-index: 5000;">
    <button class="close-modal" @click="selP = null">‚úï</button>

    <div class="slider-wrapper" style="aspect-ratio: 1/1.2; position: relative; background: #f9f9f9;">
        <template v-if="selP.variants && selP.variants[currentVariantIndex]">
            <div class="slider-inner" id="modalSlider" @scroll="e => handleScroll(e, selP)">
                <img v-for="(img, idx) in selP.variants[currentVariantIndex].images" 
                     :key="idx" :src="img" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            
            <div class="dots" v-if="selP.variants[currentVariantIndex].images.length > 1">
                <span v-for="(img, i) in selP.variants[currentVariantIndex].images" 
                      :key="i" :class="['dot', {active: i === (selP.aIdx || 0)}]">
                </span>
            </div>
        </template>
        <div v-else style="display:flex; align-items:center; justify-content:center; height:100%; color:#999; font-size:12px;">
            –ó–ê–ì–†–£–ó–ö–ê...
        </div>
    </div>

    <div v-if="selP.variants && selP.variants[currentVariantIndex]" style="padding: 25px;">
        
        <div style="display:flex; justify-content:space-between; align-items: flex-start;">
            <h2 class="brand-name" style="font-size: 18px; margin:0; text-transform: uppercase;">{{ selP.title }}</h2>
            <div class="price" style="font-size: 20px; font-weight: 800;">{{ selP.price }} ‚ÇΩ</div>
        </div>
        
        <p style="font-size: 13px; line-height: 1.6; margin: 15px 0; color: #444;">{{ selP.desc }}</p>
        
        <div style="font-size: 10px; font-weight: 800; margin-bottom: 10px; letter-spacing: 1px;">–¶–í–ï–¢: {{ selP.variants[currentVariantIndex]?.color }}</div>
        
        <div style="display: flex; gap: 8px; margin-bottom: 25px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none;">
            <div v-for="(v, idx) in selP.variants" :key="idx" 
                 @click="currentVariantIndex = idx; selP.tempSize = null; vib();"
                 :class="['color-badge', { active: currentVariantIndex === idx }]"
                 style="padding: 8px 16px; border: 1px solid #eee; border-radius: 20px; font-size: 12px; cursor: pointer; white-space: nowrap; transition: 0.2s;"
                 :style="{ background: currentVariantIndex === idx ? '#000' : '#fff', color: currentVariantIndex === idx ? '#fff' : '#000' }">
                {{ v.color }}
            </div>
        </div>

        <div style="font-size: 10px; font-weight: 800; margin-bottom: 10px; letter-spacing: 1px;">
            –†–ê–ó–ú–ï–†: {{ selP.tempSize || '–ù–ï –í–´–ë–†–ê–ù' }}
        </div>

       <div class="size-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 30px;">
    <template v-for="(qty, sz) in (selP.variants[currentVariantIndex]?.stocks || {})" :key="sz">
        
        <button v-if="!(selP.hiddenSizes || []).includes(String(sz).trim())"
                @click="qty > 0 ? (selP.tempSize = sz, vib()) : null"
                :class="['size-btn', { active: selP.tempSize === sz }]"
                :disabled="qty <= 0"
                :style="{
                    height: '45px',
                    border: '1px solid #eee',
                    borderRadius: '8px',
                    fontSize: '13px',
                    fontWeight: '700',
                    transition: '0.2s',
                    background: selP.tempSize === sz ? '#000' : (qty <= 0 ? '#f9f9f9' : '#fff'),
                    color: selP.tempSize === sz ? '#fff' : (qty <= 0 ? '#ccc' : '#000'),
                    opacity: qty <= 0 ? '0.6' : '1',
                    position: 'relative',
                    cursor: qty <= 0 ? 'not-allowed' : 'pointer'
                }">
            {{ sz }}
            <div v-if="qty > 0 && qty < 5" 
                 style="font-size: 7px; color: #ff3b30; position: absolute; bottom: 4px; width: 100%; text-align: center;">
                {{qty}} —à—Ç.
            </div>
        </button>
        
    </template>
</div>

        <div style="display: flex; gap: 10px;">
            <button @click="toggleFav(selP)" style="width: 60px; height: 50px; border: 1px solid #eee; border-radius: 8px; background: #fff; display: flex; align-items: center; justify-content: center;">
                <svg :fill="isFav(selP) ? '#000' : 'none'" viewBox="0 0 24 24" width="22" height="22" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
            </button>
            
            <button class="add-to-cart-btn" 
                    @click="addToCart(selP)" 
                    :disabled="!selP.tempSize"
                    style="flex: 1; height: 50px; border: none; border-radius: 8px; font-weight: 800; letter-spacing: 1px; transition: 0.3s;"
                    :style="{ background: selP.tempSize ? '#000' : '#ccc', color: '#fff' }">
                <span v-if="selP.tempSize">–í –ö–û–†–ó–ò–ù–£</span>
                <span v-else>–í–´–ë–ï–†–ò–¢–ï –†–ê–ó–ú–ï–†</span>
            </button>
        </div>
    </div> </div> <nav class="bottom-nav">
    <button v-for="btn in nav" :key="btn.id" 
        @click="setTab(btn.id)" 
        :class="['nav-item', {active: tab === btn.id}]"> 
        <div v-if="btn.id === 'cart' && cart.length > 0" class="badge">
            {{cart.length}}
        </div>
        <svg v-html="btn.icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"></svg>
        <span>{{btn.label}}</span>
    </button>
</nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, where, getDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
  apiKey: "AIzaSyAJRStKaq5zzApwFTXLNd16B1jwLwPDHWM",
  authDomain: "bratz-ef833.firebaseapp.com",
  projectId: "bratz-ef833",
  storageBucket: "bratz-ef833.firebasestorage.app",
  messagingSenderId: "579929073122",
  appId: "1:579929073122:web:d2925b96b792c581e985bb",
  measurementId: "G-9BT6TX72EN"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app); // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º storage
    window.db = db;
    window.fb = { collection, addDoc, onSnapshot, query, getDoc, orderBy, doc, getFirestore, getDocs, deleteDoc, updateDoc, where, db, serverTimestamp: () => storage, getDownloadURL };
</script>

<script>
const tg = window.Telegram.WebApp;

Vue.createApp({
    data() {
    return {
        selVariantIdx: 0, // –ò–Ω–¥–µ–∫—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
        deliv: '–¥–æ—Å—Ç–∞–≤–∫–∞', // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        tab: 'catalog',
        currentCat: '',
        searchQuery: '',
        searchMode: false,
        burgerOpen: false,
        loading: false,
        showProductList: false,
        activeInfo: null,
        
        products: [], 
        categories: [],
        cart: JSON.parse(localStorage.getItem('naran_cart_v3') || '[]'),
        favorites: JSON.parse(localStorage.getItem('naran_favs_v3') || '[]'),
        
        user: {},
        isAdmin: false,
        adminIds: [387881523, 5189266423],
        
        selP: null,
        currentVariantIndex: 0,
        deliv: '',
        address: '',
        map: null,
        form: {
            name: '',
            phone: localStorage.getItem('naran_phone') || ''
        },
        
        // –ü–æ–ª—è –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
        newP: {
            title: '',
            desc: '',
            price: null,
            oldPrice: null,
            category: '',
            isNew: false,
            variants: [
                { 
                    color: '', 
                    images: [], 
                    // –ó–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ–º STOCKS —Å –±—É–∫–≤–æ–π S
                    stocks: { '42': 0, '44': 0, '46': 0, '48': 0, '50': 0 },
                    isUploading: false 
                }
            ]
        },
        newCat: '',
        editId: null,
        allOrders: [],
        chart: null,
        localFiles: [], 
        myOrders: [],

        nav: [
            { id: 'catalog', label: '–ö–∞—Ç–∞–ª–æ–≥', icon: '<rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect>' },
            { id: 'favs', label: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ', icon: '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>' },
            { id: 'cart', label: '–ö–æ—Ä–∑–∏–Ω–∞', icon: '<circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>' },
            { id: 'profile', label: '–ü—Ä–æ—Ñ–∏–ª—å', icon: '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>' }
        ]
    }
},
    computed: {
        stats() {
        const now = new Date();
        const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();

        let todayCount = 0, todayRev = 0;
        let monthCount = 0, monthRev = 0;
        let allCount = 0, allRev = 0;

        this.allOrders.forEach(o => {
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∏–∑ Firebase (Timestamp) –≤ JavaScript Date
            const orderDate = o.createdAt?.seconds ? o.createdAt.seconds * 1000 : 0;
            const total = parseFloat(o.order_total) || 0;

            allCount++;
            allRev += total;

            if (orderDate >= startOfMonth) {
                monthCount++;
                monthRev += total;
            }

            if (orderDate >= startOfDay) {
                todayCount++;
                todayRev += total;
            }
        });

        return { todayCount, todayRev, monthCount, monthRev, allCount, allRev };
    },
    cartTotal() {
    const itemsSum = this.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
    // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞, –æ–±—â–∞—è —Å—É–º–º–∞ 0, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤ + 200
    return itemsSum > 0 ? itemsSum + 200 : 0;
},
    adminProducts() {
        if (!this.products) return [];
        const q = (this.searchQuery || '').toLowerCase().trim();
        return this.products.filter(p => 
            p.title.toLowerCase().includes(q) || 
            (p.color && p.color.toLowerCase().includes(q))
        );
    },
       filteredProducts() {
    // 1. –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
    if (!this.products || !Array.isArray(this.products)) return [];
    
    try {
        // 2. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ–¥–∏–Ω —Ä–∞–∑ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
        const query = (this.searchQuery || '').toLowerCase().trim();
        const targetCat = (this.currentCat || '').toLowerCase().trim();

        return this.products.filter(p => {
            // 3. –ó–∞—â–∏—Ç–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—ä–µ–∫—Ç —Ç–æ–≤–∞—Ä–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (!p) return false;

            // 4. –°–ö–†–´–¢–ò–ï: –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ hidden, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –∫–ª–∏–µ–Ω—Ç—É
            // (p?.hidden –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–µ—Ä–Ω–µ—Ç false, –µ—Å–ª–∏ —Å–≤–æ–π—Å—Ç–≤–∞ –µ—â–µ –Ω–µ—Ç –≤ –±–∞–∑–µ)
            if (p?.hidden === true) return false;

            // 5. –ü–û–ò–°–ö
            const titleMatch = query === '' || 
                (p.title && String(p.title).toLowerCase().includes(query));

            // 6. –ö–ê–¢–ï–ì–û–†–ò–Ø
            let catMatch = true;
            if (targetCat !== '' && targetCat !== '–≤—Å–µ') {
                const prodCat = p.category ? String(p.category).toLowerCase().trim() : '';
                catMatch = (prodCat === targetCat);
            }

            return titleMatch && catMatch;
        });
    } catch (e) {
        console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:", e);
        return [];
    }
},
selVariant() {
        if (!this.openedProduct || !this.openedProduct.variants) return {};
        return this.openedProduct.variants[this.selVariantIdx] || this.openedProduct.variants[0];
    },
        favList() {
            if (!this.products) return [];
            return this.products.filter(p => this.favorites.includes(p.id));
        },

        // 2. –°—á–∏—Ç–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –®–¢–£–ö –≤ –∫–æ—Ä–∑–∏–Ω–µ (–¥–ª—è –∫—Ä–∞—Å–Ω–æ–≥–æ –∫—Ä—É–∂–∫–∞ –Ω–∞ –∏–∫–æ–Ω–∫–µ)
        cartCount() {
            return this.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        },

        // 3. –°—á–∏—Ç–∞–µ—Ç –í–´–†–£–ß–ö–£ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏)
        revenue() {
                return this.allOrders.reduce((sum, o) => {
                    const val = Number(String(o.order_total || o.total || 0).replace(/\s/g, ''));
                    return sum + val;
                }, 0);
            },
    },
    methods: {
        vib() { tg.HapticFeedback.impactOccurred('light'); },
total() {
    let itemsTotal = 0;
    if (this.cart && this.cart.length > 0) {
        itemsTotal = this.cart.reduce((sum, item) => {
            let rawPrice = item.price || 0;
            let priceNumber = typeof rawPrice === 'string' 
                ? parseInt(rawPrice.replace(/[^\d]/g, '')) || 0 
                : Number(rawPrice);
            let quantity = parseInt(item.count || item.qty || 1);
            return sum + (priceNumber * quantity);
        }, 0);
    }

    // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –Ω–µ –ø—É—Å—Ç–∞, –≤—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º 200
    return itemsTotal > 0 ? (itemsTotal + 200) : 0;
},
async updateStock(product, size) {
    try {
        const productRef = window.fb.doc(window.db, "products", product.id);
        let newValue;
        let dbPath;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –ø—É—Ç—å –≤ –ë–î
        if (product.variants && product.variants[0]) {
            newValue = Number(product.variants[0].stocks[size]);
            dbPath = `variants.0.stocks.${size}`;
        } else {
            newValue = Number(product.stocks[size]);
            dbPath = `stocks.${size}`;
        }

        await window.fb.updateDoc(productRef, {
            [dbPath]: newValue
        });

        if (window.Telegram?.WebApp?.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
        }
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–∞:", e);
    }
},
        setCategory(name) {
            try {
                this.vib();
                // "–í—Å–µ —Ç–æ–≤–∞—Ä—ã" —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç –≤ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É —Å—Ç—Ä–æ–≥–æ
                this.currentCat = name || '';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:", err);
                this.currentCat = '';
            }
        },
       async fetchProducts() {
        try {
            // –ó–∞–ø—Ä–æ—Å –∫ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ products —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è
            const q = window.fb.query(
                window.fb.collection(window.db, "products"), 
                window.fb.orderBy("createdAt", "desc")
            );
            const querySnapshot = await window.fb.getDocs(q);
            
            const tempProducts = [];
            querySnapshot.forEach((doc) => {
                tempProducts.push({ id: doc.id, ...doc.data() });
            });
            
            this.products = tempProducts;
            console.log("–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:", this.products.length);
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤:", e);
        }
    },

       setTab(id) {
    if (this.vib) this.vib(); 
    this.tab = id; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–µ–Ω–Ω–æ tab, –∫–∞–∫ —É –≤–∞—Å –≤ data()

    // –ï—Å–ª–∏ –ø–µ—Ä–µ—à–ª–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å, —Ä–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫
    if (id === 'profile') {
        this.$nextTick(() => {
            // –î–∞–µ–º 200–º—Å, —á—Ç–æ–±—ã –±–ª–æ–∫ —É—Å–ø–µ–ª –ø–æ—è–≤–∏—Ç—å—Å—è –≤ HTML
            setTimeout(() => {
                if (typeof this.updateChart === 'function') {
                    this.updateChart();
                }
            }, 200);
        });
    }
},
getProductSizes(p) {
    if (!p) return [];
    const stocks = this.getStocksObject(p);
    return Object.keys(stocks);
},

// 2. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∞–º –æ–±—ä–µ–∫—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º (—á—Ç–æ–±—ã v-model —Ä–∞–±–æ—Ç–∞–ª)
getStocksObject(p) {
    if (p.variants && p.variants[0]) {
        if (!p.variants[0].stocks) p.variants[0].stocks = {};
        return p.variants[0].stocks;
    }
    if (!p.stocks) p.stocks = {};
    return p.stocks;
},

        handleScroll(e, p) {
            if (!p) return;
            const idx = Math.round(e.target.scrollLeft / e.target.offsetWidth);
            p.aIdx = idx;
        },


     openProduct(p) {
        this.openedProduct = p;
    this.selVariantIdx = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—ã–π —Ü–≤–µ—Ç –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    this.tab = 'product';   // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Ç–æ–≤–∞—Ä–∞
    window.scrollTo(0,0);
    // 1. –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å, —á—Ç–æ–±—ã –æ–Ω –Ω–µ —É–∫–∞–∑—ã–≤–∞–ª –Ω–∞ —Å—Ç–∞—Ä—ã–π —Ç–æ–≤–∞—Ä
    this.currentVariantIndex = 0;

    // 2. –î–µ–ª–∞–µ–º –≥–ª—É–±–æ–∫—É—é –∫–æ–ø–∏—é
    let productCopy = JSON.parse(JSON.stringify(p));

    // 3. –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —Å—Ç–∞—Ä—ã–π (–Ω–µ—Ç –ø–æ–ª—è variants), —Å–æ–∑–¥–∞–µ–º –µ–≥–æ –Ω–∞ –ª–µ—Ç—É
    // –≠—Ç–æ —Å–ø–∞—Å–µ—Ç –æ—Ç –æ—à–∏–±–∫–∏ "reading '0' of undefined"
    if (!productCopy.variants || !Array.isArray(productCopy.variants) || productCopy.variants.length === 0) {
        productCopy.variants = [{
            color: productCopy.color || '–°—Ç–∞–Ω–¥–∞—Ä—Ç',
            images: productCopy.images || [],
            stocks: {}
        }];
        
        // –ü–µ—Ä–µ–Ω–æ—Å–∏–º —Å—Ç–∞—Ä—ã–µ —Ä–∞–∑–º–µ—Ä—ã –≤ –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏
        if (productCopy.sizes) {
            const oldSizes = String(productCopy.sizes).split(',');
            oldSizes.forEach(s => {
                productCopy.variants[0].stocks[s.trim()] = 10; // –°—Ç–∞–≤–∏–º 10 —à—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            });
        }
    }

    // 4. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
    productCopy.aIdx = 0;

    // 5. –¢–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ selP
    this.selP = productCopy;

    // 6. –í—ã–±–æ—Ä —Ä–∞–∑–º–µ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –¢–ï–ö–£–©–ï–ì–û (–ø–µ—Ä–≤–æ–≥–æ) –≤–∞—Ä–∏–∞–Ω—Ç–∞
    const firstVar = this.selP.variants[0];
    if (firstVar && firstVar.stocks) {
        const availableSize = Object.keys(firstVar.stocks).find(sz => firstVar.stocks[sz] > 0);
        this.selP.tempSize = availableSize || Object.keys(firstVar.stocks)[0] || null;
    } else {
        this.selP.tempSize = null;
    }

    // 7. –í–∏–±—Ä–∞—Ü–∏—è
    if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
},
        isFav(p) { return p && this.favorites.includes(p.id); },
        
        toggleFav(p) {
            this.vib();
            const idx = this.favorites.indexOf(p.id);
            if (idx > -1) {
                this.favorites.splice(idx, 1);
            } else {
                this.favorites.push(p.id);
            }
            localStorage.setItem('naran_favs_v3', JSON.stringify(this.favorites));
        },

     addToCart(p) {
    if (!p) return;

    // 1. –û–ü–†–ï–î–ï–õ–Ø–ï–ú –í–ê–†–ò–ê–ù–¢
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º currentVariantIndex (—É–±–µ–¥–∏—Å—å, —á—Ç–æ –æ–Ω –µ—Å—Ç—å –≤ data)
    const vIdx = this.currentVariantIndex || 0;
    const variant = p.variants && p.variants[vIdx] ? p.variants[vIdx] : null;

    if (!variant) {
        alert("–û—à–∏–±–∫–∞: –≤–∞—Ä–∏–∞–Ω—Ç —Ç–æ–≤–∞—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω");
        return;
    }

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –æ—Å—Ç–∞—Ç–∫–∞–º (–ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ stock, –∏ stocks)
    const currentStock = variant.stocks || variant.stocks || {};

    // 2. –û–ü–†–ï–î–ï–õ–Ø–ï–ú –†–ê–ó–ú–ï–†
    let finalSize = p.tempSize;
    
    // –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω –≤—Ä—É—á–Ω—É—é, –∏—â–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
    if (!finalSize) {
        finalSize = Object.keys(currentStock).find(sz => currentStock[sz] > 0);
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å—Ç—å –ª–∏ –≤–æ–æ–±—â–µ —Ç–∞–∫–æ–π —Ä–∞–∑–º–µ—Ä –∏ –Ω–µ 0 –ª–∏ —Ç–∞–º
    if (!finalSize || !currentStock[finalSize] || currentStock[finalSize] <= 0) {
        alert('–≠—Ç–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏');
        return;
    }

    // 3. –£–ù–ò–ö–ê–õ–¨–ù–´–ô ID (ID + –¶–≤–µ—Ç + –†–∞–∑–º–µ—Ä)
    const finalColor = variant.color || '–°—Ç–∞–Ω–¥–∞—Ä—Ç';
    const cartId = `${p.id}_${finalColor}_${finalSize}`;

    // 4. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–õ–ò –î–û–ë–ê–í–õ–ï–ù–ò–ï
    const exist = this.cart.find(i => i.cartId === cartId);

    if (exist) {
        if (exist.qty < currentStock[finalSize]) {
            exist.qty++;
        } else {
            alert('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –æ—Å—Ç–∞—Ç–∫–∞');
            return;
        }
    } else {
        this.cart.push({
            id: p.id,
            cartId: cartId,
            title: p.title,
            price: p.price,
            image: (variant.images && variant.images[0]) ? variant.images[0] : (p.images ? p.images[0] : ''),
            selSize: finalSize,
            selColor: finalColor,
            qty: 1
        });
    }
    
    // 5. –≠–§–§–ï–ö–¢–´ –ò –ó–ê–ö–†–´–¢–ò–ï
    this.saveCart();
    
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    }

    this.showCartNotify = true;
    setTimeout(() => { this.showCartNotify = false; }, 2000);

    // –ü–ª–∞–≤–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    setTimeout(() => {
        this.selP = null;
        p.tempSize = null; 
    }, 300);
},
// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞ —Ü–≤–µ—Ç–∞
addVariant() {
    this.newP.variants.push({
        color: '',
        images: [],
        // –°—Ä–∞–∑—É —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç –¥–ª—è –æ—Å—Ç–∞—Ç–∫–æ–≤, —á—Ç–æ–±—ã Vue –µ–≥–æ –≤–∏–¥–µ–ª
        stocks: { '42': 0, '44': 0, '46': 0, '48': 0, '50': 0 } 
    });
},
getSizes(p) {
    if (p.variants && p.variants[0] && p.variants[0].stocks) {
        return Object.keys(p.variants[0].stocks);
    }
    if (p.stocks) {
        return Object.keys(p.stocks);
    }
    return []; // –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∏ –æ—à–∏–±–∫–∏ –Ω–µ –±—É–¥–µ—Ç
},

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ –Ω–∞ ImgBB –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
async uploadVariantImages(e, vIdx) {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    // –í–ê–® –ö–õ–Æ–ß ImgBB
    const apiKey = '839e62907e9a52f0159461b7771bcb2f'; 
    this.newP.variants[vIdx].isUploading = true;

    try {
        for (let file of files) {
            const formData = new FormData();
            formData.append('image', file);

            const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                // –ü—É—à–∏–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –≤ –º–∞—Å—Å–∏–≤ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
                this.newP.variants[vIdx].images.push(result.data.url);
            } else {
                throw new Error(result.error.message);
            }
        }
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ ImgBB:", error);
        alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + error.message);
    } finally {
        this.newP.variants[vIdx].isUploading = false;
        e.target.value = ''; // –û—á–∏—Å—Ç–∫–∞ –∏–Ω–ø—É—Ç–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
    }
},
selectFirstAvailableSize(variant) {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä–∞–∑–º–µ—Ä –≤ –Ω–æ–≤–æ–º —Ü–≤–µ—Ç–µ, –∫–æ—Ç–æ—Ä—ã–π –µ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ
    const size = Object.keys(variant.stocks).find(sz => variant.stocks[sz] > 0);
    this.selP.tempSize = size || null;
},
removePhoto(index) {
    // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å –±—Ä–∞—É–∑–µ—Ä–∞
    URL.revokeObjectURL(this.newP.localFiles[index].preview);
    this.newP.localFiles.splice(index, 1);
},
quickAddToCart(p) {
    if (!p) return;
    this.vib();

    // 1. –û–ü–†–ï–î–ï–õ–Ø–ï–ú –í–ê–†–ò–ê–ù–¢ (–î–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞ –≤—Å–µ–≥–¥–∞ –±–µ—Ä–µ–º –ü–ï–†–í–´–ô –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ü–≤–µ—Ç)
    const variant = p.variants && p.variants.length > 0 ? p.variants[0] : null;
    
    // –ï—Å–ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–µ—Ç (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤), —Å–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç
    const currentVariant = variant || { 
        color: p.color || '–°—Ç–∞–Ω–¥–∞—Ä—Ç', 
        stocks: p.stocks || p.stocks || {}, 
        images: p.images || [] 
    };

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è –ø–æ–ª—è stock
    const currentStock = currentVariant.stocks || currentVariant.stocks || {};

    // 2. –û–ü–†–ï–î–ï–õ–Ø–ï–ú –†–ê–ó–ú–ï–†
    // –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∫–ª–∏–∫–Ω—É–ª –Ω–∞ —á–∏–ø –≤ –∫–∞—Ç–∞–ª–æ–≥–µ ‚Äî –±–µ—Ä–µ–º –µ–≥–æ (tempSize)
    // –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –∏—â–µ–º –ø–µ—Ä–≤—ã–π —Ä–∞–∑–º–µ—Ä, –≥–¥–µ –æ—Å—Ç–∞—Ç–æ–∫ > 0
    let selSize = p.tempSize;
    if (!selSize) {
        selSize = Object.keys(currentStock).find(sz => currentStock[sz] > 0);
    }

    // –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞, —á—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç —Å–∞–º –ø–æ—Å–º–æ—Ç—Ä–µ–ª
    if (!selSize || currentStock[selSize] <= 0) {
        return this.openProduct(p);
    }

    // 3. –ü–†–û–í–ï–†–ö–ê –°–ö–†–´–¢–´–• –†–ê–ó–ú–ï–†–û–í (–µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å —Ç–∞–∫–∞—è –ª–æ–≥–∏–∫–∞)
    if (p.hiddenSizes && p.hiddenSizes.includes(String(selSize))) {
        return; 
    }

    // 4. –§–û–†–ú–ò–†–£–ï–ú –£–ù–ò–ö–ê–õ–¨–ù–´–ô ID (ID —Ç–æ–≤–∞—Ä–∞ + –¶–≤–µ—Ç + –†–∞–∑–º–µ—Ä)
    const currentColor = currentVariant.color;
    const cartId = `${p.id}_${currentColor}_${selSize}`;
    
    // 5. –î–û–ë–ê–í–õ–ï–ù–ò–ï –í –ö–û–†–ó–ò–ù–£
    const exist = this.cart.find(i => i.cartId === cartId);
    
    if (exist) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ–º –ª–∏ –º—ã –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ
        if (exist.qty < (currentStock[selSize] || 99)) {
            exist.qty++;
        } else {
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.showAlert('–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –±–æ–ª—å—à–µ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏');
            }
            return;
        }
    } else {
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É
        this.cart.push({ 
            id: p.id,
            cartId: cartId,
            title: p.title,
            price: Number(p.price),
            // –ë–µ—Ä–µ–º —Ñ–æ—Ç–æ –∏–º–µ–Ω–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
            img: currentVariant.images[0] || (p.images ? p.images[0] : ''),
            selSize: selSize,
            selColor: currentColor,
            qty: 1
        });
    }

    this.saveCart();
    
    // Telegram —Ñ–∏–¥–±–µ–∫
    if (window.Telegram?.WebApp?.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    }
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–ª–∞—à–∫–∏ "–î–æ–±–∞–≤–ª–µ–Ω–æ"
    this.showCartNotify = true;
    setTimeout(() => { this.showCartNotify = false; }, 2000);
},
      changeQty(item, delta) {
    // 1. –ù–∞—Ö–æ–¥–∏–º —Ç–æ–≤–∞—Ä –≤ –æ–±—â–µ–º —Å–ø–∏—Å–∫–µ products, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–∫–ª–∞–¥
    const product = this.products.find(p => p.id === item.id);
    if (!product) return;

    // 2. –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—ã–π —Å–∫–ª–∞–¥ (stock) –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
    const variant = product.variants.find(v => v.color === item.selColor);
    if (!variant) return;

    const maxStock = variant.stocks[item.selSize] || 0;

    if (delta > 0) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â–µ –º–µ—Å—Ç–æ –Ω–∞ —Å–∫–ª–∞–¥–µ
        if (item.qty < maxStock) {
            item.qty++;
            this.vib('light');
        } else {
            // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –º–∞–ª–µ–Ω—å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–ë–æ–ª—å—à–µ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏"
            if(window.Telegram?.WebApp) window.Telegram.WebApp.showAlert("–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —ç—Ç–æ –≤—Å—ë, —á—Ç–æ –µ—Å—Ç—å –≤ –Ω–∞–ª–∏—á–∏–∏");
        }
    } else {
        // –£–º–µ–Ω—å—à–∞–µ–º –∏–ª–∏ —É–¥–∞–ª—è–µ–º
        if (item.qty > 1) {
            item.qty--;
            this.vib('light');
        } else {
            this.removeFromCart(item.cartId);
        }
    }
    this.saveCart();
},

removeFromCart(cartId) {
    this.cart = this.cart.filter(i => i.cartId !== cartId);
    this.saveCart();
    this.vib('medium');
},

        saveCart() {
            localStorage.setItem('naran_cart_v3', JSON.stringify(this.cart));
        },

        setDelivery(d) {
    this.deliv = d; // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ deliv, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ —É —Ç–µ–±—è –≤ data()
    this.vib();
    // –ï—Å–ª–∏ —É —Ç–µ–±—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∫–∞—Ä—Ç–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ:
    if (this.initMap) this.initMap();
        },

        initMap() {
            try {
                if (this.map) { this.map.destroy(); this.map = null; }
                
                // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É –∫–ª—é—á–∞: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –Ω–∞–ø—Ä—è–º—É—é
                const currentKey = 'cab82c94-e619-42eb-9814-3361712feaf0';
                
                this.map = new mapgl.Map('map', {
                    center: [37.6175, 55.7558],
                    zoom: 13,
                    key: currentKey
                });

                const setPos = (lat, lon) => {
                    this.map.setCenter([lon, lat]);
                    this.map.setZoom(15);
                    this.getAddress(lat, lon);
                };

                // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Telegram –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º
                // –ï—Å–ª–∏ –º—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω–∞ –ü–ö, –∫–æ–¥ –ø—Ä–æ—Å—Ç–æ –ø–æ–π–¥–µ—Ç –¥–∞–ª—å—à–µ –±–µ–∑ –æ—à–∏–±–∫–∏
                if (window.Telegram?.WebApp?.initData !== "") {
                    try {
                        window.Telegram.WebApp.requestLocation((data) => {
                            if (data?.location) setPos(data.location.latitude, data.location.longitude);
                        });
                    } catch (e) { console.log("TG Geo skip"); }
                } 
                
                // –í—Å–µ–≥–¥–∞ –ø—Ä–æ–±—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π –º–µ—Ç–æ–¥ (–æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ü–ö)
                navigator.geolocation.getCurrentPosition(
                    (p) => setPos(p.coords.latitude, p.coords.longitude),
                    (err) => console.log("–ì–µ–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º")
                );

                this.map.on('click', (e) => {
                    this.getAddress(e.lngLat[1], e.lngLat[0]);
                });
            } catch (e) { console.error("Map error", e); }
        },

       getAddress(lat, lon) {
    const currentKey = 'cab82c94-e619-42eb-9814-3361712feaf0';
    // –î–æ–±–∞–≤–∏–ª–∏ –∑–∞–ø—Ä–æ—Å –≤—Å–µ—Ö –ø–æ–ª–µ–π, –≥–¥–µ –º–æ–∂–µ—Ç –ø—Ä—è—Ç–∞—Ç—å—Å—è –≥–æ—Ä–æ–¥
    const url = `https://catalog.api.2gis.com/3.0/items/geocode?lat=${lat}&lon=${lon}&radius=50&fields=items.adm_div,items.address,items.full_name&key=${currentKey}`;

    fetch(url)
        .then(r => r.json())
        .then(res => {
            if (res.result?.items?.length) {
                const item = res.result.items[0];
                let city = '';

                // 1. –ò—â–µ–º –≥–æ—Ä–æ–¥ –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–º –¥–µ–ª–µ–Ω–∏–∏
                if (item.adm_div) {
                    const c = item.adm_div.find(d => ['city', 'settlement', 'district'].includes(d.type));
                    if (c) city = c.name;
                }

                // 2. –ï—Å–ª–∏ –ú–æ—Å–∫–≤–∞ –≤—Å—ë –µ—â–µ –Ω–µ –Ω–∞—à–ª–∞—Å—å, –±–µ—Ä–µ–º –µ—ë –∏–∑ full_name (—Ç–∞–º –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å –≥–æ—Ä–æ–¥)
                if (!city && item.full_name) {
                    // –†–∞–∑–±–∏–≤–∞–µ–º "–ú–æ—Å–∫–≤–∞, –ú–∞–Ω–µ–∂–Ω–∞—è –ø–ª–æ—â–∞–¥—å, 1" –∏ –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –∫—É—Å–æ–∫
                    city = item.full_name.split(',')[0].trim();
                }

                // 3. –ï—Å–ª–∏ –≥–æ—Ä–æ–¥ - —ç—Ç–æ –æ–∫—Ä—É–≥ –ú–æ—Å–∫–≤—ã (–Ω–∞–ø—Ä. –ó–µ–ª–µ–Ω–æ–≥—Ä–∞–¥), –ø—Ä–æ–≤–µ—Ä—è–µ–º —ç—Ç–æ
                const streetHouse = item.address_name || item.name;
                
                // –°–æ–±–∏—Ä–∞–µ–º –∞–¥—Ä–µ—Å. –ï—Å–ª–∏ –≥–æ—Ä–æ–¥ —É–∂–µ –µ—Å—Ç—å –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ —É–ª–∏—Ü—ã, –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º
                let cleanAddress = streetHouse;
                if (city && !streetHouse.toLowerCase().includes(city.toLowerCase())) {
                    cleanAddress = city + ', ' + streetHouse;
                }

                // –¢–í–û–Ø –õ–û–ì–ò–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô)
                const fullAddr = (this.deliv ? this.deliv + ': ' : '') + cleanAddress;
                
                this.address = fullAddr; 
                if (this.form) this.form.address = fullAddr; 
                localStorage.setItem('naran_last_addr', fullAddr); 
                
                this.$forceUpdate();
                
                if (window.Telegram?.WebApp?.HapticFeedback) {
                    window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                }
            }
        })
        .catch(err => console.error("2GIS error", err));
},

        openSupport() { window.open('https://t.me/@Asya_Candy_Bratz', '_blank'); },
        

async uploadFile(file) {
    try {
        const imgbbKey = '839e62907e9a52f0159461b7771bcb2f'; // –¢–≤–æ–π –∫–ª—é—á ImgBB
        const formData = new FormData();
        formData.append('image', file);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ö–æ—Å—Ç–∏–Ω–≥ ImgBB –≤–º–µ—Å—Ç–æ Firebase
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey}`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            console.log('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ ImgBB:', result.data.url);
            return result.data.url; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É
        } else {
            throw new Error(result.error.message);
        }
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ ImgBB:', e);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ: ' + e.message);
        throw e;
    }
},
async compressImage(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 1000; 
                let width = img.width;
                let height = img.height;
                
                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
                
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob((blob) => {
                    resolve(new File([blob], file.name, { type: 'image/jpeg' }));
                }, 'image/jpeg', 0.8); // –ö–∞—á–µ—Å—Ç–≤–æ 80% ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Å–∞–π—Ç–∞
            };
        };
    });
},
async saveProduct() {
    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!this.newP.title || !this.newP.price || !this.newP.category) {
        return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω—É –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é!');
    }
    
    if (!this.newP.variants?.[0]?.images?.length) {
        return alert('–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ñ–æ—Ç–æ!');
    }

    this.loading = true; // –í–∫–ª—é—á–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±–µ–ª—ã–π —ç–∫—Ä–∞–Ω)
    
    try {
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å –≥–ª—É–±–æ–∫–∏–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        const productData = {
            title: this.newP.title.trim(),
            desc: this.newP.desc || '',
            price: Number(this.newP.price),
            oldPrice: this.newP.oldPrice ? Number(this.newP.oldPrice) : null,
            category: this.newP.category,
            isNew: !!this.newP.isNew,
            hidden: !!this.newP.hidden,
            hiddenSizes: this.newP.hiddenSizes || [],
            variants: JSON.parse(JSON.stringify(this.newP.variants)),
            images: [this.newP.variants[0].images[0]], 
            updatedAt: Date.now()
        };

        if (this.editId) {
            // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–æ–≤–∞—Ä–∞
            const docRef = window.fb.doc(window.db, "products", this.editId);
            await window.fb.updateDoc(docRef, productData);
            
            const idx = this.products.findIndex(p => p.id === this.editId);
            if (idx !== -1) {
                this.products.splice(idx, 1, { id: this.editId, ...productData });
            }
            alert('–û–±–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!');
        } else {
            // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
            productData.createdAt = Date.now();
            const docRef = await window.fb.addDoc(window.fb.collection(window.db, "products"), productData);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            this.products.unshift({ id: docRef.id, ...productData }); 
            alert('–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
        }

        // --- –ü–ï–†–ï–•–û–î –ü–û–°–õ–ï –£–°–ü–ï–•–ê ---
        this.cancelEdit();       // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        this.tab = 'profile';    // –û–¢–ö–†–´–í–ê–ï–ú –í–ö–õ–ê–î–ö–£ –ü–†–û–§–ò–õ–Ø (—É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–º—è –≤–∫–ª–∞–¥–∫–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç)
        
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);
        alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ' + e.message);
    } finally {
        // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–∞–¥–µ—Ä–∞, —á—Ç–æ–±—ã –Ω–µ –≤–∏—Å–µ–ª –±–µ–ª—ã–π —ç–∫—Ä–∞–Ω
        this.loading = false;
    }
},
    editProduct(p) {
    this.editId = p.id;
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º JSON.parse –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞ —Å—Ä–∞–∑—É
    const cleanItem = JSON.parse(JSON.stringify(p));
    
    this.newP = {
        title: cleanItem.title || '',
        desc: cleanItem.desc || '',
        price: cleanItem.price || null,
        oldPrice: cleanItem.oldPrice || null,
        category: cleanItem.category || '',
        isNew: !!cleanItem.isNew,
        hiddenSizes: cleanItem.hiddenSizes || [], // –í–∞–∂–Ω–æ –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å, —á—Ç–æ–±—ã –Ω–µ —Å—Ç–µ—Ä–µ—Ç—å!
        variants: cleanItem.variants || [
            { color: '–°—Ç–∞–Ω–¥–∞—Ä—Ç', images: cleanItem.images || [], stocks: { '42': 0, '44': 0, '46': 0, '48': 0, '50': 0 } }
        ]
    };
    
    this.showProductList = false; // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫, –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
    window.scrollTo(0, 0);
},

cancelEdit() {
    this.editId = null;
    this.showProductList = true;
    
    // –ü—Ä–∏–≤–æ–¥–∏–º –∫ —Ç–æ–º—É –∂–µ –≤–∏–¥—É, —á—Ç–æ –∏ –≤ editProduct
    this.newP = {
        title: '',
        desc: '',
        price: null,
        oldPrice: null,
        category: '',
        isNew: false,
        hiddenSizes: [],
        variants: [
            { color: '', images: [], stocks: { '42': 0, '44': 0, '46': 0, '48': 0, '50': 0 } }
        ]
    };
    
    if (this.localFiles) this.localFiles = []; 
},

        async deleteProduct(id) {
            const msg = "‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞–≤—Å–µ–≥–¥–∞?";
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞: –∫–∞–∫ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    const runDelete = async () => {
        try {
            await window.fb.deleteDoc(window.fb.doc(window.db, "orders", docId));
            if (window.tg && window.tg.HapticFeedback) window.tg.HapticFeedback.notificationOccurred('success');
        } catch (e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + e.message);
        }
    };

    if (window.tg && window.tg.showConfirm) {
        // –ï—Å–ª–∏ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–µ
        window.tg.showConfirm(msg, (yes) => { if (yes) runDelete(); });
    } else {
        // –ï—Å–ª–∏ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
        if (confirm(msg)) runDelete();
    }
},
// –í –º–µ—Ç–æ–¥–∞—Ö Vue –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
async toggleVariantSizeVisibility(p, v, sz) {
    try {
        const productRef = window.fb.doc(window.db, "products", p.id);
        
        // 1. –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –í–ê–†–ò–ê–ù–¢–ê (—Ü–≤–µ—Ç–∞) –µ—Å—Ç—å –º–∞—Å—Å–∏–≤ hiddenSizes
        if (!v.hiddenSizes) {
            v.hiddenSizes = [];
        }
        
        const sizeStr = String(sz);
        const index = v.hiddenSizes.indexOf(sizeStr);

        if (index > -1) {
            v.hiddenSizes.splice(index, 1); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º (—É–¥–∞–ª—è–µ–º –∏–∑ —Å–∫—Ä—ã—Ç—ã—Ö)
        } else {
            v.hiddenSizes.push(sizeStr); // –°–∫—Ä—ã–≤–∞–µ–º (–¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å–∫—Ä—ã—Ç—ã–µ)
        }

        // 2. –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Å—å –º–∞—Å—Å–∏–≤ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        // –¢–∞–∫ –∫–∞–∫ v ‚Äî —ç—Ç–æ —á–∞—Å—Ç—å p.variants, –∏–∑–º–µ–Ω–µ–Ω–∏—è —É–∂–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å –∫ p.variants –ª–æ–∫–∞–ª—å–Ω–æ
        await window.fb.updateDoc(productRef, {
            variants: p.variants
        });

        this.vib('light');
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ —Ä–∞–∑–º–µ—Ä–∞:", e);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è");
    }
},

async deleteProductWithConfirm(productId) {
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞–≤—Å–µ–≥–¥–∞ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –∏–∑ –æ–±–ª–∞–∫–∞?")) {
        try {
            await window.fb.deleteDoc(window.fb.doc(window.db, "products", productId));
        } catch (e) {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");
        }
    }
},

async manageCategory(action, id) {
    try {
        if (action === 'add' && this.newCat && this.newCat.trim()) {
            await window.fb.addDoc(window.fb.collection(window.db, "categories"), { 
                name: this.newCat.trim() 
            });
            this.newCat = '';
        } else if (action === 'del') {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?")) {
                await window.fb.deleteDoc(window.fb.doc(window.db, "categories", id));
            }
        }
    } catch (e) {
        alert("–û—à–∏–±–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: " + e.message);
    }
},
async checkout() {
    this.vib();
    
    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!this.form.name || !this.form.phone || !this.address) {
        return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏!");
    }
    if (this.cart.length === 0) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!");

    this.loading = true;
    
    try {
        // 2. –°–ù–ò–ñ–ï–ù–ò–ï –û–°–¢–ê–¢–ö–û–í –í FIREBASE
        for (let item of this.cart) {
            const pRef = window.fb.doc(window.db, "products", item.id);
            const pSnap = await window.fb.getDoc(pRef);
            
            if (pSnap.exists()) {
                let d = pSnap.data();
                const sz = String(item.selSize || item.size); // –ü—Ä–∏–≤–æ–¥–∏–º –∫ —Å—Ç—Ä–æ–∫–µ
                const qty = Number(item.qty || 1);

                // –ï—Å–ª–∏ —É —Ç–æ–≤–∞—Ä–∞ –µ—Å—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã (—Ü–≤–µ—Ç–∞)
                if (d.variants && d.variants.length > 0) {
                    let updatedVariants = [...d.variants];
                    // –ò—â–µ–º –Ω—É–∂–Ω—ã–π —Ü–≤–µ—Ç –≤ –º–∞—Å—Å–∏–≤–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
                    let vIdx = updatedVariants.findIndex(v => v.color === (item.selColor || item.color));
                    
                    if (vIdx > -1) {
                        let targetVariant = updatedVariants[vIdx];
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—è stocks –∏–ª–∏ stock
                        let currentStocks = targetVariant.stocks || targetVariant.stock || {};
                        
                        if (currentStocks[sz] !== undefined) {
                            currentStocks[sz] = Math.max(0, Number(currentStocks[sz]) - qty);
                            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Å—å –º–∞—Å—Å–∏–≤ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ
                            await window.fb.updateDoc(pRef, { variants: updatedVariants });
                        }
                    }
                } 
            }
        }

        // 3. –ü–û–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ù–´–• –î–õ–Ø –ü–ê–ô–¢–û–ù-–ë–û–¢–ê
        const finalTotal = this.total(); 
        const orderData = {
            order_id: Math.floor(1000 + Math.random() * 9000),
            customer_name: this.form.name,
            customer_phone: this.form.phone,
            address: this.address,
            delivery_type: '–¥–æ—Å—Ç–∞–≤–∫–∞',
            delivery_price: 200,
            // –ú–∞—Å—Å–∏–≤ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –±–æ—Ç–∞
            items: this.cart.map(i => ({
                id: i.id,
                title: i.title,
                count: i.qty || 1,
                color: i.selColor || i.color || '-',
                size: i.selSize || i.size || '-',
                price: i.price
            })),
            order_total: finalTotal, 
            status: '–ù–æ–≤—ã–π',
            createdAt: Date.now(),
            // –°–¢–†–£–ö–¢–£–†–ê –î–õ–Ø –¢–í–û–ï–ì–û –ü–ê–ô–¢–û–ù –°–ö–†–ò–ü–¢–ê
            user: {
                id: window.tg?.initDataUnsafe?.user?.id || 0
            }
        };

        // 4. –°–û–•–†–ê–ù–ï–ù–ò–ï –í –ë–ê–ó–£
        await window.fb.addDoc(window.fb.collection(window.db, "orders"), orderData);
        
        // 5. –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –ê–î–ú–ò–ù–ê (—á–µ—Ä–µ–∑ TOKEN –∏–∑ —Ç–≤–æ–µ–≥–æ Python-—Ñ–∞–π–ª–∞)
        const botToken = '8313765701:AAG4pb1Pr351VLYTfUuuCzumMk6y96E_mdQ';
        const adminId = 387881523; 
        
        let itemsText = orderData.items.map(i => `‚Ä¢ ${i.title} (${i.color}, ${i.size}) x${i.count}`).join('\n');
        let adminMsg = `üõç *–ù–û–í–´–ô –ó–ê–ö–ê–ó ‚Ññ${orderData.order_id}*\n` +
                       `üë§ –ö–ª–∏–µ–Ω—Ç: ${orderData.customer_name}\n` +
                       `üìç –ê–¥—Ä–µ—Å: ${orderData.address}\n\n` +
                       `üìã –°–æ—Å—Ç–∞–≤:\n${itemsText}\n\n` +
                       `üí∞ –ò—Ç–æ–≥–æ: *${finalTotal} ‚ÇΩ*`;

        await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: adminId, text: adminMsg, parse_mode: 'Markdown' })
        }).catch(e => console.error("–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:", e));

        alert(`–ó–∞–∫–∞–∑ #${orderData.order_id} –æ—Ñ–æ—Ä–º–ª–µ–Ω!`);
        
        // –û—á–∏—Å—Ç–∫–∞
        this.cart = [];
        this.saveCart();
        this.tab = 'catalog'; 
        
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞:", e);
        alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏.");
    } finally {
        this.loading = false;
    }
},
// –ú–µ—Ç–æ–¥ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–í –ø—É—Ç–∏" –∏ "–ì–æ—Ç–æ–≤"
async updateStatus(order, newStatus) {
    if (order.status === newStatus) return;

    try {
        order.isUpdating = true;
        const orderRef = window.fb.doc(window.db, "orders", order.id);
        await window.fb.updateDoc(orderRef, { status: newStatus });
        
        // --- –ë–õ–û–ö –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ---
        const botToken = '8546116032:AAGHzNWm8ueB5ynxIgzf6OLM7EdbA2geEbk';
        
        // –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–µ—Ö, –∫—Ç–æ –ø–æ–ª—É—á–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
        const recipients = [];
        
        // 1. –î–æ–±–∞–≤–ª—è–µ–º ID –∫–ª–∏–µ–Ω—Ç–∞
        const customerId = order.user_id || (order.user ? order.user.id : null);
        if (customerId) recipients.push(customerId);
        
        // 2. –î–æ–±–∞–≤–ª—è–µ–º —Ç–≤–æ–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ ID (–∞–¥–º–∏–Ω—ã, –º–µ–Ω–µ–¥–∂–µ—Ä—ã)
        const extraIds = [641527014, 387881523]; // –ó–ê–ú–ï–ù–ò –≠–¢–ò –¶–ò–§–†–´ –ù–ê –ù–£–ñ–ù–´–ï ID
        extraIds.forEach(id => {
            if (!recipients.includes(id)) recipients.push(id);
        });

        let message = "";
        if (newStatus === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω') {
            message = `üöÄ *–ó–∞–∫–∞–∑ ‚Ññ${order.order_id} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!*\n\nüì¶ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞: ${newStatus}`;
        } else if (newStatus === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω') {
            message = `‚úÖ *–ó–∞–∫–∞–∑ ‚Ññ${order.order_id} –¥–æ—Å—Ç–∞–≤–ª–µ–Ω!*\n\n–°—Ç–∞—Ç—É—Å: ${newStatus}`;
        }

        if (message && recipients.length > 0) {
            // –†–∞—Å—Å—ã–ª–∞–µ–º –≤—Å–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞ recipients
            for (const targetId of recipients) {
                try {
                    await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: targetId,
                            text: message,
                            parse_mode: 'Markdown'
                        })
                    });
                    console.log(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ ID: ${targetId}`);
                } catch (err) {
                    console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–ª—è ${targetId}:`, err);
                }
            }
        }
        // --- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ---

        if (window.tg?.HapticFeedback) window.tg.HapticFeedback.impactOccurred('medium');

    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", e);
        alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –±–∞–∑–æ–π.");
    } finally {
        order.isUpdating = false;
    }
},
handleFiles(e) {
    const files = Array.from(e.target.files);
    if (!this.newP.localFiles) this.newP.localFiles = [];
    
    files.forEach(file => {
        this.newP.localFiles.push({
            file: file,
            preview: URL.createObjectURL(file) // –°—Å—ã–ª–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ <img>
        });
    });
    e.target.value = ''; // –û—á–∏—Å—Ç–∫–∞ –∏–Ω–ø—É—Ç–∞
},

async deleteOrder(docId) {
    const confirmText = "‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞–≤—Å–µ–≥–¥–∞?";
    
    const proceedDelete = async () => {
        try {
            await window.fb.deleteDoc(window.fb.doc(window.db, "orders", docId));
            if (window.tg && window.tg.version && parseFloat(window.tg.version) >= 6.1) {
                window.tg.HapticFeedback.notificationOccurred('success');
            }
        } catch (e) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: " + e.message);
        }
    };

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–ü–ö + –¢–ì)
    if (window.tg && window.tg.showConfirm && parseFloat(window.tg.version) >= 6.2) {
        window.tg.showConfirm(confirmText, (yes) => { if (yes) proceedDelete(); });
    } else {
        if (confirm(confirmText)) proceedDelete();
    }
},

       printOrder(o) {
    try {
        this.vib(); // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è –≤–∏–±—Ä–∞—Ü–∏–∏
        const date = o.createdAt ? (o.createdAt.seconds ? new Date(o.createdAt.seconds * 1000).toLocaleString('ru-RU') : new Date(o.createdAt).toLocaleString('ru-RU')) : '---';
        
        // 1. –û–ü–†–ï–î–ï–õ–Ø–ï–ú –ú–ê–°–°–ò–í –¢–û–í–ê–†–û–í (–≤–∞–∂–Ω–æ –±—Ä–∞—Ç—å –∏–∑ –∑–∞–∫–∞–∑–∞ 'o', –∞ –Ω–µ –∏–∑ 'this.cart')
        const itemsList = o.items || []; 
        let itemsHtml = '';

        // 2. –ì–ï–ù–ï–†–ò–†–£–ï–ú HTML –¢–û–í–ê–†–û–í
        if (Array.isArray(itemsList) && itemsList.length > 0) {
            itemsHtml = itemsList.map(i => `
                <tr style="border-bottom: 2px solid #f0f0f0;">
                    <td style="padding: 20px 0;">
                        <div style="font-weight: 800; font-size: 20px; text-transform: uppercase; margin-bottom: 10px;">
                            ${i.title || '–¢–æ–≤–∞—Ä –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}
                        </div>
                        <div style="display: flex; gap: 30px; font-size: 14px; color: #333;">
                            <span><b>–¶–≤–µ—Ç:</b> ${i.selColor || i.color || '-'}</span>
                            <span><b>–†–∞–∑–º–µ—Ä:</b> ${i.selSize || i.size || '-'}</span>
                            <span><b>–ö–æ–ª-–≤–æ:</b> ${i.qty || i.count || 1} —à—Ç.</span>
                            <span><b>–¶–µ–Ω–∞ –∑–∞ –µ–¥.:</b> ${i.price || 0} ‚ÇΩ</span>
                        </div>
                    </td>
                    <td style="padding: 20px 0; text-align: right; vertical-align: middle;">
                        <div style="font-weight: 800; font-size: 20px;">
                            ${(i.price || 0) * (i.qty || i.count || 1)} ‚ÇΩ
                        </div>
                    </td>
                </tr>
            `).join('');
        } else {
            // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –ø—É—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∏–∑ items_text
            itemsHtml = `<tr><td colspan="2" style="padding: 40px 0; font-size: 16px; white-space: pre-wrap;">${o.items_text || '–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω'}</td></tr>`;
        }

        const win = window.open('', '_blank');
        if (!win) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.");
            return;
        }

        win.document.write(`
            <html>
            <head>
                <title>–ù–∞–∫–ª–∞–¥–Ω–∞—è #${o.order_id}</title>
                <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">
                <style>
                    @page { size: A4 portrait; margin: 15mm; }
                    body { font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; color: #000; }
                    .wrapper { width: 100%; max-width: 210mm; margin: auto; }
                    .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; border-bottom: 4px solid #000; padding-bottom: 20px; }
                    .brand h1 { margin: 0; font-size: 35px; font-weight: 800; letter-spacing: -1px; }
                    .brand p { margin: 0; color: #888; font-weight: 700; font-size: 12px; }
                    .order-info { text-align: right; }
                    .order-info h2 { margin: 0; font-size: 24px; font-weight: 800; }
                    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px; }
                    .address-box { border: 2px solid #000; padding: 20px; margin-bottom: 30px; }
                    table { width: 100%; border-collapse: collapse; }
                    th { text-align: left; text-transform: uppercase; font-size: 12px; color: #888; border-bottom: 1px solid #000; padding-bottom: 10px; }
                    .total-section { margin-top: 50px; text-align: right; border-top: 4px solid #000; padding-top: 20px; }
                    .total-section h2 { margin: 0; font-size: 45px; font-weight: 800; }
                </style>
            </head>
            <body>
                <div class="wrapper">
                    <div class="header">
                        <div class="brand"><h1>BRATZ</h1><p>–û–§–ò–¶–ò–ê–õ–¨–ù–´–ô –ß–ï–ö –ó–ê–ö–ê–ó–ê</p></div>
                        <div class="order-info"><h2>–ó–ê–ö–ê–ó #${o.order_id}</h2><p>–î–∞—Ç–∞: ${date}</p></div>
                    </div>
                    <div class="info-grid">
                        <div>
                            <small style="color:#888; font-weight:700;">–ü–û–ö–£–ü–ê–¢–ï–õ–¨</small>
                            <p style="font-size: 18px; font-weight: 700; margin: 5px 0;">${o.customer_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                            <p>${o.customer_phone || '---'}</p>
                        </div>
                        <div style="text-align: right;">
                            <small style="color:#888; font-weight:700;">–°–ü–û–°–û–ë –î–û–°–¢–ê–í–ö–ò</small>
                            <p style="font-size: 18px; font-weight: 700; margin: 5px 0;">${o.delivery || '–°—Ç–∞–Ω–¥–∞—Ä—Ç'}</p>
                        </div>
                    </div>
                    <div class="address-box">
                        <small style="color:#888; font-weight:700;">–ê–î–†–ï–° –î–û–°–¢–ê–í–ö–ò:</small>
                        <p style="font-size: 22px; font-weight: 800; margin: 10px 0 0 0;">${o.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤</th>
                                <th style="text-align: right;">–°—É–º–º–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>
                    <div class="total-section">
                        <div style="font-weight: 700; color: #888;">–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï</div>
                        <h2>${o.order_total || 0} ‚ÇΩ</h2>
                    </div>
                </div>
                <script>
                    window.onload = function() { 
                        window.print(); 
                        setTimeout(() => { window.close(); }, 700); 
                    };
                <\/script>
            </body>
            </html>
        `);
        win.document.close();
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏:", e);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —á–µ–∫–∞.");
    }
},
updateChart() {
    const ctx = document.getElementById('orderChart');
    if (!ctx) return; // –í–∞–∂–Ω–æ: –µ—Å–ª–∏ –º—ã –Ω–µ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –∞–¥–º–∏–Ω–∞, –≤—ã—Ö–æ–¥–∏–º

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –∏—Ö –µ—â–µ –Ω–µ—Ç
    const orders = this.allOrders || [];
    const labels = [];
    const counts = [];
    const now = new Date();

    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(now.getDate() - i);
        labels.push(d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }));
        
        const dayStart = new Date(d.setHours(0,0,0,0)).getTime();
        const dayEnd = new Date(d.setHours(23,59,59,999)).getTime();
        
        const dayOrders = orders.filter(o => {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞: o.createdAt –º–æ–∂–µ—Ç –±—ã—Ç—å –ª–∏–±–æ Timestamp, –ª–∏–±–æ —á–∏—Å–ª–æ–º Date.now()
            let t = 0;
            if (o.createdAt?.seconds) t = o.createdAt.seconds * 1000;
            else if (typeof o.createdAt === 'number') t = o.createdAt;
            
            return t >= dayStart && t <= dayEnd;
        });
        counts.push(dayOrders.length);
    }

    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ
    if (this.chart && typeof this.chart.destroy === 'function') {
        this.chart.destroy();
    }

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
    try {
        this.chart = new Chart(ctx, {
            type: 'line',
            data: {
                deliveryType: 'pickup',
                labels: labels,
                datasets: [{
                    label: '–ó–∞–∫–∞–∑—ã',
                    data: counts,
                    borderColor: '#000',
                    backgroundColor: 'rgba(0,0,0,0.05)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: '#000'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // –ß—Ç–æ–±—ã –≥—Ä–∞—Ñ–∏–∫ –Ω–µ "–ø—Ä—ã–≥–∞–ª" –ø–æ –≤—ã—Å–æ—Ç–µ
                animation: { duration: 500 }, // –ù–µ–º–Ω–æ–≥–æ —É–º–µ–Ω—å—à–∏–º –≤—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { display: false }, ticks: { stepSize: 1 } },
                    x: { grid: { display: false } }
                }
            }
        });
    } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞:", err);
    }
}
    },
     mounted() {
    tg.ready();
    tg.expand();
    this.fetchProducts();
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    this.user = tg.initDataUnsafe?.user || { id: 387881523, first_name: 'Admin_Test' };
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞
    this.isAdmin = this.adminIds.includes(Number(this.user.id));
    console.log("Admin Status:", this.isAdmin, "User ID:", this.user.id);

    // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
    const initFirebaseData = () => {
        if (window.db && window.fb) {
            console.log("Firebase detected, starting listeners...");
            
            // 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
            window.fb.onSnapshot(
                window.fb.query(window.fb.collection(window.db, "products"), window.fb.orderBy("createdAt", "desc")), 
                snap => {
                    this.products = snap.docs.map(doc => ({ id: doc.id, ...doc.data(), aIdx: 0 }));
                },
                err => console.error("Products leak:", err)
            );

            // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            window.fb.onSnapshot(
                window.fb.collection(window.db, "categories"), 
                snap => {
                    this.categories = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
            );

            // 3. –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)
            if (this.isAdmin) {
                window.fb.onSnapshot(
                    window.fb.query(window.fb.collection(window.db, "orders"), window.fb.orderBy("createdAt", "desc")), 
                    snap => {
                        this.allOrders = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∞–¥–º–∏–Ω —Å–µ–π—á–∞—Å –≤–∏–¥–∏—Ç —ç—Ç–æ—Ç —ç–∫—Ä–∞–Ω
                        if (this.tab === 'admin') {
                            this.$nextTick(() => { 
                                if (typeof this.updateChart === 'function') this.updateChart(); 
                            });
                        }
                    }
                );
            }

            // 4. –ó–∞–≥—Ä—É–∑–∫–∞ –ª–∏—á–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const qMy = window.fb.query(
                window.fb.collection(window.db, "orders"), 
                window.fb.where("user.id", "==", this.user.id)
            );
            window.fb.onSnapshot(qMy, snap => {
                this.myOrders = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });

        } else {
            // –ï—Å–ª–∏ Firebase –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤, –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 100–º—Å
            setTimeout(initFirebaseData, 100);
        }
    };

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
    initFirebaseData();

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    const savedAddr = localStorage.getItem('naran_last_addr');
    if (savedAddr) {
        this.address = savedAddr; // –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –≤ data –µ—Å—Ç—å –ø–æ–ª–µ address
    }
}
}).mount('#app');
</script>

</body>
</html>
